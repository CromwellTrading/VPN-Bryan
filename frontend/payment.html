<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN Cuba - Pago</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <!-- L√≠neas decorativas futuristas -->
        <div class="connection-line top-left"></div>
        <div class="connection-line top-right"></div>
        <div class="connection-line bottom-left"></div>
        <div class="connection-line bottom-right"></div>
        <div class="pulse-dot center"></div>
        
        <div class="header">
            <div class="logo-container">
                <div class="logo-glow"></div>
                <h1>VPN CUBA</h1>
            </div>
            <p class="subtitle">Completa tu compra</p>
        </div>
        
        <div class="payment-container">
            <!-- Resumen del Plan -->
            <div class="plan-summary">
                <h3 class="summary-title">Resumen de tu compra</h3>
                <div class="summary-details">
                    <div class="detail-row">
                        <span class="detail-label">Plan seleccionado:</span>
                        <span class="detail-value" id="planName">Plan Mensual</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Precio:</span>
                        <span class="detail-value" id="planPrice">$10</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ID de Usuario:</span>
                        <span class="detail-value" id="userId">---</span>
                    </div>
                </div>
            </div>
            
            <!-- Instrucciones de Pago -->
            <div class="payment-instructions">
                <h3 class="instructions-title">Instrucciones de Pago</h3>
                <div class="instructions-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Realiza la transferencia</h4>
                            <div class="payment-details">
                                <div class="bank-info">
                                    <span class="info-label">Banco:</span>
                                    <span class="info-value">Banco Metropolitano</span>
                                </div>
                                <div class="bank-info">
                                    <span class="info-label">Tarjeta:</span>
                                    <span class="info-value">1234 5678 9012 3456</span>
                                    <button class="copy-btn" onclick="copyToClipboard('1234 5678 9012 3456')">üìã</button>
                                </div>
                                <div class="bank-info">
                                    <span class="info-label">Nombre:</span>
                                    <span class="info-value">Juan P√©rez Garc√≠a</span>
                                </div>
                            </div>
                            <div class="alternative-payment">
                                <p><strong>Alternativa:</strong> Tambi√©n puedes pagar con USDT (TRC20)</p>
                                <div class="bank-info">
                                    <span class="info-label">Wallet:</span>
                                    <span class="info-value">TXXXXXXXXXXXXXXXXXXXXXXXX</span>
                                    <button class="copy-btn" onclick="copyToClipboard('TXXXXXXXXXXXXXXXXXXXXXXXX')">üìã</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Toma una captura de pantalla</h4>
                            <p>Aseg√∫rate de que en la captura se vea:</p>
                            <ul class="screenshot-tips">
                                <li>El monto transferido</li>
                                <li>El n√∫mero de referencia</li>
                                <li>La fecha y hora</li>
                                <li>El destinatario (si es posible)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Sube la captura aqu√≠</h4>
                            <p>Sube la imagen del comprobante de pago:</p>
                            
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-icon">üì§</div>
                                <div class="upload-text">Arrastra o haz clic para subir</div>
                                <div class="upload-subtext">Formatos: JPG, PNG, PDF (M√°x. 5MB)</div>
                                <input type="file" id="screenshotInput" accept="image/*,.pdf" hidden>
                            </div>
                            
                            <div class="preview-container" id="previewContainer" style="display: none;">
                                <div class="preview-header">
                                    <span>Vista previa:</span>
                                    <button class="remove-btn" onclick="removeImage()">‚úï</button>
                                </div>
                                <img id="imagePreview" class="preview-image">
                            </div>
                            
                            <div class="notes-container">
                                <label for="paymentNotes" class="notes-label">Notas adicionales (opcional):</label>
                                <textarea id="paymentNotes" class="notes-textarea" 
                                          placeholder="Ej: N√∫mero de referencia, hora exacta, etc."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bot√≥n de enviar -->
            <button id="submitBtn" class="btn-primary" onclick="submitPayment()" disabled>
                <span class="btn-icon">üì®</span>
                <span class="btn-text">Enviar comprobante de pago</span>
                <div class="btn-glow"></div>
            </button>
            
            <div class="processing-info">
                <div class="info-icon">‚è≥</div>
                <div class="info-text">
                    <strong>Proceso de verificaci√≥n:</strong> Tu pago ser√° verificado manualmente en un plazo de 1-12 horas. Recibir√°s una notificaci√≥n cuando sea aprobado.
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p class="footer-text">¬© 2025 VPN Cuba. Todos los derechos reservados.</p>
        </div>
    </div>

    <script>
        // Inicializar Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();
        
        // Obtener par√°metros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId') || tg.initDataUnsafe.user?.id;
        const planType = urlParams.get('plan') || 'mensual';
        const price = urlParams.get('price') || '10';
        
        // Variables globales
        let selectedFile = null;
        
        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar informaci√≥n del plan
            const planNames = {
                'mensual': 'Plan Mensual',
                'trimestral': 'Plan Trimestral',
                'anual': 'Plan Anual'
            };
            
            document.getElementById('planName').textContent = planNames[planType] || 'Plan Mensual';
            document.getElementById('planPrice').textContent = `$${price}`;
            document.getElementById('userId').textContent = userId || 'No disponible';
            
            // Configurar √°rea de upload
            setupUploadArea();
            
            // Verificar si el usuario acept√≥ los t√©rminos
            checkTermsAccepted();
        });
        
        // Configurar √°rea de upload
        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('screenshotInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFile(e.target.files[0]);
                }
            });
        }
        
        // Manejar archivo seleccionado
        function handleFile(file) {
            // Validar tama√±o (5MB m√°ximo)
            if (file.size > 5 * 1024 * 1024) {
                alert('El archivo es demasiado grande. M√°ximo 5MB.');
                return;
            }
            
            // Validar tipo
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('Formato no v√°lido. Solo JPG, PNG, GIF o PDF.');
                return;
            }
            
            selectedFile = file;
            
            // Mostrar vista previa si es imagen
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    document.getElementById('previewContainer').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                // Para PDF, mostrar nombre del archivo
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('imagePreview').src = '';
                document.getElementById('imagePreview').alt = `PDF: ${file.name}`;
            }
            
            // Habilitar bot√≥n de enviar
            document.getElementById('submitBtn').disabled = false;
        }
        
        // Eliminar imagen
        function removeImage() {
            selectedFile = null;
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('screenshotInput').value = '';
            document.getElementById('submitBtn').disabled = true;
        }
        
        // Copiar al portapapeles
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = event.target.textContent;
                event.target.textContent = '‚úì';
                setTimeout(() => {
                    event.target.textContent = originalText;
                }, 2000);
            });
        }
        
        // Enviar pago
        async function submitPayment() {
            if (!selectedFile) {
                alert('Por favor, selecciona un archivo primero.');
                return;
            }
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Enviando...</span>';
            
            const formData = new FormData();
            formData.append('telegramId', userId);
            formData.append('plan', planType);
            formData.append('price', price);
            formData.append('screenshot', selectedFile);
            formData.append('notes', document.getElementById('paymentNotes').value);
            
            try {
                const response = await fetch(`${window.API_BASE_URL || ''}/api/payment`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Mostrar mensaje de √©xito
                    alert('‚úÖ Comprobante enviado correctamente. Tu pago ser√° verificado en 1-12 horas. Recibir√°s una notificaci√≥n cuando sea aprobado.');
                    
                    // Cerrar WebApp o redirigir
                    tg.close();
                } else {
                    throw new Error('Error al enviar el comprobante');
                }
            } catch (error) {
                alert('‚ùå Error al enviar el comprobante. Por favor, intenta de nuevo.');
                btn.disabled = false;
                btn.innerHTML = '<span class="btn-icon">üì®</span><span class="btn-text">Enviar comprobante de pago</span>';
            }
        }
        
        // Verificar si el usuario acept√≥ los t√©rminos
        async function checkTermsAccepted() {
            try {
                const response = await fetch(`${window.API_BASE_URL || ''}/api/check-terms/${userId}`);
                const data = await response.json();
                
                if (!data.accepted) {
                    // Si no ha aceptado los t√©rminos, redirigir a la p√°gina de t√©rminos
                    window.location.href = `index.html?userId=${userId}`;
                }
            } catch (error) {
                console.error('Error verificando t√©rminos:', error);
            }
        }
    </script>
</body>
</html>
