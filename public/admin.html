<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN Cuba - Panel de Administraci√≥n</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* VARIABLES Y RESET */
        :root {
            --primary: #0a0a1f;
            --secondary: #121230;
            --accent: #4f46e5;
            --accent-light: #6366f1;
            --accent-glow: rgba(79, 70, 229, 0.4);
            --text: #ffffff;
            --text-secondary: #a5b4fc;
            --card-bg: rgba(18, 18, 48, 0.9);
            --border: rgba(99, 102, 241, 0.2);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --trial: #10b981;
            --trial-light: #34d399;
            --trial-glow: rgba(16, 185, 129, 0.4);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --game-color: #8b5cf6;
            --connection-color: #3b82f6;
            --broadcast-color: #8b5cf6;
            --broadcast-glow: rgba(139, 92, 246, 0.4);
            --referral-color: #8b5cf6;
            --usdt-color: #f0b90b;
            --annual-green: #39ff14;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* CONTAINER */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        .header {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 40px;
            border-bottom: 2px solid rgba(79, 70, 229, 0.3);
        }

        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--accent);
            margin-right: 15px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #a5b4fc 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        /* CARDS */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* ESTAD√çSTICAS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .stat-card.users .stat-value { color: var(--accent); }
        .stat-card.users .stat-icon { color: var(--accent); }
        
        .stat-card.vip .stat-value { color: var(--warning); }
        .stat-card.vip .stat-icon { color: var(--warning); }
        
        .stat-card.trial .stat-value { color: var(--trial); }
        .stat-card.trial .stat-icon { color: var(--trial); }
        
        .stat-card.revenue .stat-value { color: var(--success); }
        .stat-card.revenue .stat-icon { color: var(--success); }
        
        .stat-card.pending .stat-value { color: var(--warning); }
        .stat-card.pending .stat-icon { color: var(--warning); }

        .stat-card.trial-pending .stat-value { color: var(--trial-light); }
        .stat-card.trial-pending .stat-icon { color: var(--trial-light); }

        .stat-card.games .stat-value { color: var(--game-color); }
        .stat-card.games .stat-icon { color: var(--game-color); }
        
        .stat-card.connections .stat-value { color: var(--connection-color); }
        .stat-card.connections .stat-icon { color: var(--connection-color); }

        .stat-card.broadcast .stat-value { color: var(--broadcast-color); }
        .stat-card.broadcast .stat-icon { color: var(--broadcast-color); }

        .stat-card.referrals .stat-value { color: var(--referral-color); }
        .stat-card.referrals .stat-icon { color: var(--referral-color); }

        .stat-card.usdt .stat-value { color: var(--usdt-color); }
        .stat-card.usdt .stat-icon { color: var(--usdt-color); }

        /* TABLAS */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(79, 70, 229, 0.2);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* BADGES */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge.approved {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge.vip {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .badge.trial {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.trial-pending {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.3);
            animation: pulse 2s infinite;
        }

        .badge.non-vip {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .badge.game {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .badge.connection {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge.broadcast {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .badge.sending {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
            animation: pulse 1.5s infinite;
        }

        .badge.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge.referral-level-1 {
            background: rgba(139, 92, 246, 0.3);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.4);
        }

        .badge.referral-level-2 {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.25);
        }

        .badge.paid {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.unpaid {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .badge.usdt {
            background: rgba(240, 185, 11, 0.2);
            color: #f0b90b;
            border: 1px solid rgba(240, 185, 11, 0.3);
        }

        .badge.annual {
            background: rgba(57, 255, 20, 0.2);
            color: var(--annual-green);
            border: 1px solid rgba(57, 255, 20, 0.3);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* BOTONES DE ACCI√ìN */
        .action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .action-btn.approve {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .action-btn.approve:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .action-btn.reject {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .action-btn.reject:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .action-btn.send-config {
            background: rgba(79, 70, 229, 0.2);
            color: var(--accent-light);
            border: 1px solid rgba(79, 70, 229, 0.3);
        }

        .action-btn.send-config:hover {
            background: rgba(79, 70, 229, 0.3);
        }

        .action-btn.message {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .action-btn.message:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .action-btn.remove-vip {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .action-btn.remove-vip:hover {
            background: rgba(245, 158, 11, 0.3);
        }

        .action-btn.send-trial {
            background: rgba(16, 185, 129, 0.2);
            color: var(--trial-light);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .action-btn.send-trial:hover {
            background: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 15px var(--trial-glow);
        }

        .action-btn.send-broadcast {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .action-btn.send-broadcast:hover {
            background: rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 15px var(--broadcast-glow);
        }

        .action-btn.view-details {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent-light);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .action-btn.view-details:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .screenshot-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .config-form {
            margin-top: 20px;
        }

        .file-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text);
            margin-bottom: 15px;
        }

        .submit-config {
            width: 100%;
            padding: 15px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-config:hover {
            background: var(--accent-light);
        }

        .submit-trial {
            width: 100%;
            padding: 15px;
            background: var(--trial);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-trial:hover {
            background: var(--trial-light);
            box-shadow: 0 0 20px var(--trial-glow);
        }

        .submit-broadcast {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--broadcast-color) 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-broadcast:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--broadcast-glow);
        }

        .submit-broadcast:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .card {
                padding: 20px;
            }
            
            th, td {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .action-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                margin-right: 4px;
            }
        }

        /* NOTIFICACI√ìN */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--card-bg);
            border: 1px solid;
            border-radius: 12px;
            color: var(--text);
            font-weight: 500;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .notification.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .notification.warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .notification.info {
            border-color: var(--accent);
            background: rgba(79, 70, 229, 0.1);
        }
        
        /* SECCI√ìN DE REFERIDOS */
        .referrals-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .referral-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .referral-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
        }
        
        .referral-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .referral-stat {
            text-align: center;
            padding: 10px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
        }
        
        .referral-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #a78bfa;
            margin-bottom: 5px;
        }
        
        .referral-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .referral-discount {
            background: rgba(139, 92, 246, 0.15);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .discount-title {
            font-size: 1rem;
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 8px;
        }
        
        .discount-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .discount-level {
            color: var(--text-secondary);
        }
        
        .discount-percent {
            color: #34d399;
            font-weight: 600;
        }
        
        /* PANEL DE ARCHIVOS DE PLANES */
        .plan-files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .plan-file-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .plan-file-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .plan-file-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .plan-file-badge {
            background: rgba(79, 70, 229, 0.2);
            color: var(--accent-light);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .plan-file-info {
            margin-bottom: 15px;
        }
        
        .plan-file-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .plan-file-label {
            color: var(--text-secondary);
        }
        
        .plan-file-value {
            color: var(--text);
            font-weight: 500;
        }
        
        .file-upload-area {
            border: 2px dashed rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .file-upload-area:hover {
            border-color: rgba(79, 70, 229, 0.6);
            background: rgba(79, 70, 229, 0.05);
        }
        
        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .file-upload-text {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
        }
        
        .file-upload-subtext {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        /* INFO BOX */
        .info-box {
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
            color: var(--trial-light);
            font-size: 0.9rem;
        }

        .info-box i {
            margin-right: 10px;
            color: var(--trial-light);
        }

        .info-box.broadcast {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .info-box.broadcast i {
            color: #a78bfa;
        }
        
        .info-box.referral {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }
        
        .info-box.referral i {
            color: #a78bfa;
        }
        
        .info-box.usdt {
            background: rgba(240, 185, 11, 0.1);
            border: 1px solid rgba(240, 185, 11, 0.2);
            color: #f0b90b;
        }
        
        .info-box.usdt i {
            color: #f0b90b;
        }

        /* PROGRESS BAR */
        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .progress-text {
            color: var(--text-secondary);
        }

        .progress-percent {
            color: var(--text);
            font-weight: 600;
        }

        /* FORMULARIOS */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 500;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            font-family: inherit;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .form-textarea {
            width: 100%;
            padding: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            font-family: inherit;
            min-height: 150px;
            resize: vertical;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        /* STATS GRID */
        .stats-mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stat-mini {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            text-align: center;
        }

        .stat-mini-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-mini-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* BROADCAST PROGRESS */
        .broadcast-progress {
            padding: 20px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .broadcast-progress.active {
            display: block;
        }

        .broadcast-progress-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .broadcast-progress-title {
            font-weight: 600;
            color: var(--text);
        }

        .broadcast-progress-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        /* BADGE ANUAL */
        .plan-file-badge.anual {
            background: rgba(57, 255, 20, 0.2);
            color: var(--annual-green);
            border: 1px solid rgba(57, 255, 20, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="header">
            <div class="logo-container">
                <i class="fas fa-shield-alt logo-icon"></i>
                <h1 class="title">VPN CUBA ADMIN</h1>
            </div>
            <p class="subtitle">Panel de administraci√≥n - Gesti√≥n de usuarios, pagos, referidos y archivos de planes</p>
        </header>

        <!-- TABS - ACTUALIZADAS -->
        <div class="tabs">
            <div class="tab active" data-tab="stats">üìä Estad√≠sticas</div>
            <div class="tab" data-tab="pending">‚è≥ Pagos Pendientes</div>
            <div class="tab" data-tab="trial-pending">üéØ Pruebas Pendientes</div>
            <div class="tab" data-tab="approved">‚úÖ Pagos Aprobados</div>
            <div class="tab" data-tab="users">üë• Usuarios</div>
            <div class="tab" data-tab="referrals">ü§ù Referidos</div>
            <div class="tab" data-tab="plan-files">üìÅ Archivos de Planes</div>
            <div class="tab" data-tab="games">üéÆ Juegos/Servidores</div>
            <div class="tab" data-tab="broadcast">üì¢ Broadcast</div>
        </div>

        <!-- ESTAD√çSTICAS - ACTUALIZADAS -->
        <div id="statsContent" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card users">
                    <i class="fas fa-users stat-icon"></i>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Usuarios Totales</div>
                </div>
                
                <div class="stat-card vip">
                    <i class="fas fa-crown stat-icon"></i>
                    <div class="stat-value" id="vipUsers">0</div>
                    <div class="stat-label">Usuarios VIP</div>
                </div>
                
                <div class="stat-card trial">
                    <i class="fas fa-gift stat-icon"></i>
                    <div class="stat-value" id="trialRequests">0</div>
                    <div class="stat-label">Solicitudes de Prueba</div>
                </div>
                
                <div class="stat-card trial-pending">
                    <i class="fas fa-clock stat-icon"></i>
                    <div class="stat-value" id="trialPendingCount">0</div>
                    <div class="stat-label">Pruebas Pendientes</div>
                </div>
                
                <div class="stat-card pending">
                    <i class="fas fa-clock stat-icon"></i>
                    <div class="stat-value" id="pendingPaymentsCount">0</div>
                    <div class="stat-label">Pagos Pendientes</div>
                </div>
                
                <div class="stat-card revenue">
                    <i class="fas fa-money-bill-wave stat-icon"></i>
                    <div class="stat-value" id="totalRevenue">0</div>
                    <div class="stat-label">Ingresos Totales (CUP)</div>
                </div>
                
                <div class="stat-card referrals">
                    <i class="fas fa-users stat-icon"></i>
                    <div class="stat-value" id="totalReferrals">0</div>
                    <div class="stat-label">Referidos Totales</div>
                </div>
                
                <div class="stat-card usdt">
                    <i class="fab fa-usd stat-icon"></i>
                    <div class="stat-value" id="usdtPayments">0</div>
                    <div class="stat-label">Pagos USDT</div>
                </div>

                <div class="stat-card broadcast">
                    <i class="fas fa-bullhorn stat-icon"></i>
                    <div class="stat-value" id="broadcastCount">0</div>
                    <div class="stat-label">Broadcasts Enviados</div>
                </div>
            </div>
        </div>

        <!-- PAGOS PENDIENTES -->
        <div id="pendingContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-clock"></i>
                        Pagos Pendientes
                    </h2>
                    <button class="refresh-btn" onclick="loadPendingPayments()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <div class="loading" id="pendingLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando pagos pendientes...</p>
                </div>
                
                <div class="table-container">
                    <table id="pendingTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Plan</th>
                                <th>M√©todo</th>
                                <th>Monto</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="pendingNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay pagos pendientes</p>
                </div>
            </div>
        </div>

        <!-- PRUEBAS PENDIENTES -->
        <div id="trial-pendingContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-gift"></i>
                        Pruebas Pendientes
                    </h2>
                    <button class="refresh-btn" onclick="loadPendingTrials()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    Estos usuarios solicitaron una prueba gratuita y est√°n esperando el archivo de configuraci√≥n.
                </div>
                
                <div class="loading" id="trialLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando pruebas pendientes...</p>
                </div>
                
                <div class="table-container">
                    <table id="trialTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>üéÆ Juego/Servidor</th>
                                <th>üì° Conexi√≥n</th>
                                <th>Solicitado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="trialTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="trialNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay pruebas pendientes</p>
                </div>
            </div>
        </div>

        <!-- PAGOS APROBADOS -->
        <div id="approvedContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-check-circle"></i>
                        Pagos Aprobados
                    </h2>
                    <button class="refresh-btn" onclick="loadApprovedPayments()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <div class="loading" id="approvedLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando pagos aprobados...</p>
                </div>
                
                <div class="table-container">
                    <table id="approvedTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Plan</th>
                                <th>M√©todo</th>
                                <th>Monto</th>
                                <th>Aprobado</th>
                                <th>Configuraci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="approvedTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="approvedNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay pagos aprobados</p>
                </div>
            </div>
        </div>

        <!-- USUARIOS -->
        <div id="usersContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        Usuarios Registrados
                    </h2>
                    <button class="refresh-btn" onclick="loadUsers()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <div class="loading" id="usersLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando usuarios...</p>
                </div>
                
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Usuario</th>
                                <th>Plan</th>
                                <th>Referidor</th>
                                <th>Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="usersNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay usuarios registrados</p>
                </div>
            </div>
        </div>

        <!-- SISTEMA DE REFERIDOS - NUEVA SECCI√ìN -->
        <div id="referralsContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        Sistema de Referidos
                    </h2>
                    <button class="refresh-btn" onclick="loadReferrals()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>

                <div class="info-box referral">
                    <i class="fas fa-info-circle"></i>
                    <strong>Descuentos por referidos:</strong><br>
                    ‚Ä¢ Nivel 1 (referido directo): 20% de descuento por cada referido que pague.<br>
                    ‚Ä¢ Nivel 2 (referido del referido): 10% de descuento por cada referido que pague.<br>
                    Solo se aplica descuento si el referido ha pagado su plan. Los referidos que no pagan solo cuentan como n√∫mero, no como descuento.
                </div>
                
                <div class="referrals-container">
                    <div class="referral-card">
                        <div class="referral-header">
                            <i class="fas fa-user-friends" style="color: #a78bfa;"></i>
                            <div class="referral-title">Resumen de Referidos</div>
                        </div>
                        
                        <div class="referral-stats">
                            <div class="referral-stat">
                                <div class="referral-stat-value" id="totalReferralsCount">0</div>
                                <div class="referral-stat-label">Referidos Totales</div>
                            </div>
                            <div class="referral-stat">
                                <div class="referral-stat-value" id="paidReferrals">0</div>
                                <div class="referral-stat-label">Referidos Pagados</div>
                            </div>
                            <div class="referral-stat">
                                <div class="referral-stat-value" id="level1Referrals">0</div>
                                <div class="referral-stat-label">Nivel 1</div>
                            </div>
                            <div class="referral-stat">
                                <div class="referral-stat-value" id="level2Referrals">0</div>
                                <div class="referral-stat-label">Nivel 2</div>
                            </div>
                        </div>
                        
                        <div class="referral-discount">
                            <div class="discount-title">Descuentos Aplicables</div>
                            <div class="discount-item">
                                <span class="discount-level">Nivel 1 (20%):</span>
                                <span class="discount-percent" id="level1Discount">0%</span>
                            </div>
                            <div class="discount-item">
                                <span class="discount-level">Nivel 2 (10%):</span>
                                <span class="discount-percent" id="level2Discount">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="referral-card">
                        <div class="referral-header">
                            <i class="fas fa-chart-line" style="color: #a78bfa;"></i>
                            <div class="referral-title">Top Referidores</div>
                        </div>
                        
                        <div class="loading" id="topReferrersLoading">
                            <div class="loading-spinner"></div>
                            <p>Cargando top referidores...</p>
                        </div>
                        
                        <div class="table-container">
                            <table id="topReferrersTable">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Referidos</th>
                                        <th>Pagados</th>
                                        <th>Descuento</th>
                                    </tr>
                                </thead>
                                <tbody id="topReferrersTableBody">
                                    <!-- Datos se cargar√°n aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list"></i>
                            Lista de Referidos
                        </h3>
                    </div>
                    
                    <div class="loading" id="referralsListLoading">
                        <div class="loading-spinner"></div>
                        <p>Cargando lista de referidos...</p>
                    </div>
                    
                    <div class="table-container">
                        <table id="referralsListTable">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Referidor</th>
                                    <th>Nivel</th>
                                    <th>Plan</th>
                                    <th>Estado Pago</th>
                                    <th>Descuento</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="referralsListTableBody">
                                <!-- Datos se cargar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ARCHIVOS DE PLANES - NUEVA SECCI√ìN -->
        <div id="plan-filesContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-file-upload"></i>
                        Gesti√≥n de Archivos de Planes
                    </h2>
                    <button class="refresh-btn" onclick="loadPlanFiles()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    Sube aqu√≠ los archivos de configuraci√≥n para cada plan. Cuando un usuario pague (manualmente o por USDT), se le enviar√° autom√°ticamente el archivo correspondiente a su plan.
                </div>
                
                <div class="plan-files-grid">
                    <!-- PLAN B√ÅSICO -->
                    <div class="plan-file-card">
                        <div class="plan-file-header">
                            <div class="plan-file-title">Plan B√°sico</div>
                            <span class="plan-file-badge">1 mes</span>
                        </div>
                        
                        <div class="plan-file-info">
                            <div class="plan-file-row">
                                <span class="plan-file-label">Precio:</span>
                                <span class="plan-file-value">800 CUP / 1.6 USDT</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Archivo actual:</span>
                                <span class="plan-file-value" id="basicPlanFile">No subido</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">√öltima actualizaci√≥n:</span>
                                <span class="plan-file-value" id="basicPlanDate">N/A</span>
                            </div>
                        </div>
                        
                        <div class="file-upload-area" onclick="openPlanFileUpload('basico')" id="basicUploadArea">
                            <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                            <div class="file-upload-text">Subir archivo para B√°sico</div>
                            <div class="file-upload-subtext">Archivo .conf, .zip o .rar</div>
                        </div>
                        
                        <input type="file" id="basicPlanFileInput" accept=".conf,.zip,.rar" hidden>
                    </div>
                    
                    <!-- PLAN AVANZADO -->
                    <div class="plan-file-card">
                        <div class="plan-file-header">
                            <div class="plan-file-title">Plan Avanzado</div>
                            <span class="plan-file-badge">2 meses</span>
                        </div>
                        
                        <div class="plan-file-info">
                            <div class="plan-file-row">
                                <span class="plan-file-label">Precio:</span>
                                <span class="plan-file-value">1,300 CUP / 2.7 USDT</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Archivo actual:</span>
                                <span class="plan-file-value" id="advancedPlanFile">No subido</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">√öltima actualizaci√≥n:</span>
                                <span class="plan-file-value" id="advancedPlanDate">N/A</span>
                            </div>
                        </div>
                        
                        <div class="file-upload-area" onclick="openPlanFileUpload('avanzado')" id="advancedUploadArea">
                            <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                            <div class="file-upload-text">Subir archivo para Avanzado</div>
                            <div class="file-upload-subtext">Archivo .conf, .zip o .rar</div>
                        </div>
                        
                        <input type="file" id="advancedPlanFileInput" accept=".conf,.zip,.rar" hidden>
                    </div>
                    
                    <!-- PLAN PREMIUM -->
                    <div class="plan-file-card">
                        <div class="plan-file-header">
                            <div class="plan-file-title">Plan Premium</div>
                            <span class="plan-file-badge">1 mes</span>
                        </div>
                        
                        <div class="plan-file-info">
                            <div class="plan-file-row">
                                <span class="plan-file-label">Precio:</span>
                                <span class="plan-file-value">1,200 CUP / 2.5 USDT</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Archivo actual:</span>
                                <span class="plan-file-value" id="premiumPlanFile">No subido</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">√öltima actualizaci√≥n:</span>
                                <span class="plan-file-value" id="premiumPlanDate">N/A</span>
                            </div>
                        </div>
                        
                        <div class="file-upload-area" onclick="openPlanFileUpload('premium')" id="premiumUploadArea">
                            <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                            <div class="file-upload-text">Subir archivo para Premium</div>
                            <div class="file-upload-subtext">Archivo .conf, .zip o .rar</div>
                        </div>
                        
                        <input type="file" id="premiumPlanFileInput" accept=".conf,.zip,.rar" hidden>
                    </div>
                    
                    <!-- PLAN ANUAL -->
                    <div class="plan-file-card">
                        <div class="plan-file-header">
                            <div class="plan-file-title">Plan Anual</div>
                            <span class="plan-file-badge anual">12 meses</span>
                        </div>
                        
                        <div class="plan-file-info">
                            <div class="plan-file-row">
                                <span class="plan-file-label">Precio:</span>
                                <span class="plan-file-value">15,000 CUP / 30 USDT</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Archivo actual:</span>
                                <span class="plan-file-value" id="annualPlanFile">No subido</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">√öltima actualizaci√≥n:</span>
                                <span class="plan-file-value" id="annualPlanDate">N/A</span>
                            </div>
                        </div>
                        
                        <div class="file-upload-area" onclick="openPlanFileUpload('anual')" id="annualUploadArea">
                            <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                            <div class="file-upload-text">Subir archivo para Anual</div>
                            <div class="file-upload-subtext">Archivo .conf, .zip o .rar</div>
                        </div>
                        
                        <input type="file" id="annualPlanFileInput" accept=".conf,.zip,.rar" hidden>
                    </div>
                </div>
                
                <div class="info-box usdt" style="margin-top: 20px;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Sistema de detecci√≥n de pagos USDT:</strong><br>
                    ‚Ä¢ Se genera un monto √∫nico (0.01 a 0.15 USDT) para cada usuario<br>
                    ‚Ä¢ El usuario debe enviar la cantidad exacta<br>
                    ‚Ä¢ El sistema detecta autom√°ticamente el pago<br>
                    ‚Ä¢ Se env√≠a el archivo correspondiente al plan pagado<br>
                    ‚Ä¢ Si no se detecta pago en 15 minutos, el munto se libera para otro usuario
                </div>
            </div>
        </div>

        <!-- JUEGOS/SERVIDORES -->
        <div id="gamesContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-gamepad"></i>
                        Juegos/Servidores Solicitados
                    </h2>
                    <button class="refresh-btn" onclick="loadGamesStats()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <div class="loading" id="gamesLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando estad√≠sticas de juegos...</p>
                </div>
                
                <div class="table-container">
                    <table id="gamesTable">
                        <thead>
                            <tr>
                                <th>üéÆ Juego/Servidor</th>
                                <th>Solicitudes</th>
                                <th>üì° Tipo de Conexi√≥n</th>
                                <th>√öltima Solicitud</th>
                            </tr>
                        </thead>
                        <tbody id="gamesTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="gamesNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-gamepad" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay datos de juegos/servidores</p>
                </div>
            </div>
        </div>

        <!-- BROADCAST -->
        <div id="broadcastContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-bullhorn"></i>
                        Enviar Mensaje Masivo (Broadcast)
                    </h2>
                </div>

                <div class="info-box broadcast">
                    <i class="fas fa-info-circle"></i>
                    Env√≠a un mensaje a m√∫ltiples usuarios simult√°neamente. Los mensajes se enviar√°n en segundo plano y podr√°s monitorear el progreso.
                </div>
                
                <div class="broadcast-form">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-users"></i> Destinatarios:
                        </label>
                        <select id="broadcastTarget" class="form-select">
                            <option value="all">üë• Todos los usuarios</option>
                            <option value="vip">üëë Solo usuarios VIP</option>
                            <option value="non_vip">üë§ Usuarios no VIP</option>
                            <option value="trial_pending">‚è≥ Usuarios con prueba pendiente</option>
                            <option value="trial_received">‚úÖ Usuarios que recibieron prueba</option>
                            <option value="active">üì± Usuarios activos (√∫ltimos 30 d√≠as)</option>
                            <option value="with_referrals">ü§ù Usuarios con referidos</option>
                            <option value="usdt_payers">üí∞ Usuarios que pagaron con USDT</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-comment-alt"></i> Mensaje:
                        </label>
                        <textarea id="broadcastMessage" class="form-textarea" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                    </div>
                    
                    <button class="submit-broadcast" onclick="sendBroadcast()" id="broadcastButton">
                        <i class="fas fa-paper-plane"></i>
                        Enviar Broadcast
                    </button>
                </div>
            </div>
            
            <!-- HISTORIAL DE BROADCASTS -->
            <div class="card" style="margin-top: 25px;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-history"></i>
                        Historial de Broadcasts
                    </h2>
                    <button class="refresh-btn" onclick="loadBroadcasts()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <div class="loading" id="broadcastLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando historial de broadcasts...</p>
                </div>
                
                <div class="table-container">
                    <table id="broadcastTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Mensaje</th>
                                <th>Destinatarios</th>
                                <th>Enviados</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="broadcastTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="broadcastNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-bullhorn" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay broadcasts en el historial</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA VER CAPTURA -->
    <div id="screenshotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Captura de Pantalla</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <img id="screenshotImage" class="screenshot-preview" src="" alt="Captura de pantalla">
            <div class="payment-info">
                <p><strong>Usuario:</strong> <span id="modalUserId"></span></p>
                <p><strong>Plan:</strong> <span id="modalPlan"></span></p>
                <p><strong>Monto:</strong> $<span id="modalAmount"></span> CUP</p>
                <p><strong>Fecha:</strong> <span id="modalDate"></span></p>
            </div>
            <div class="action-buttons">
                <button class="action-btn approve" onclick="approvePayment(currentPaymentId)">
                    <i class="fas fa-check"></i>
                    Aprobar Pago
                </button>
                <button class="action-btn reject" onclick="rejectPayment(currentPaymentId)">
                    <i class="fas fa-times"></i>
                    Rechazar Pago
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA ENVIAR CONFIGURACI√ìN -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Enviar Configuraci√≥n</h3>
                <button class="close-modal" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="config-form">
                <p><strong>Usuario:</strong> <span id="configUserId"></span></p>
                <p><strong>Plan:</strong> <span id="configPlan"></span></p>
                <p><strong>Pago ID:</strong> <span id="configPaymentId"></span></p>
                
                <div style="margin-bottom: 15px;">
                    <p style="color: #a5b4fc; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i>
                        Se permiten archivos .conf, .zip o .rar
                    </p>
                </div>
                
                <input type="file" id="configFile" class="file-input" accept=".conf,.zip,.rar">
                
                <button class="submit-config" onclick="sendConfigFile()">
                    <i class="fas fa-paper-plane"></i>
                    Enviar Configuraci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- NOTIFICACI√ìN -->
    <div id="notification" class="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationText">Mensaje</span>
    </div>

    <script>
        // Variables globales
        let currentPaymentId = null;
        let currentTab = 'stats';
        let currentUserId = null;
        let currentTrialUserId = null;
        let isAdminUser = false;
        let currentPlanForUpload = null;

        // Inicializar Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();

        // Obtener par√°metros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        const admin = urlParams.get('admin') === 'true';

        // Verificar permisos de administrador
        async function checkAdminAccess() {
            console.log('üîç Verificando acceso de administrador...');
            
            if (!admin) {
                console.log('‚ùå Par√°metro admin=false o no presente');
                showNotification('‚ùå No tienes permisos de administrador', 'error');
                setTimeout(() => {
                    window.location.href = '/plans.html?userId=' + userId;
                }, 2000);
                return;
            }

            try {
                console.log(`üë§ Verificando admin para ${userId}`);
                const response = await fetch(`/api/check-admin/${userId}`);
                const data = await response.json();
                
                if (!data.isAdmin) {
                    console.log('‚ùå Usuario no es administrador');
                    showNotification('‚ùå No eres administrador', 'error');
                    setTimeout(() => {
                        window.location.href = '/plans.html?userId=' + userId;
                    }, 2000);
                    return;
                }

                isAdminUser = true;
                currentUserId = userId;
                console.log('‚úÖ Usuario es administrador');
                loadStats();
                loadPlanFiles();
            } catch (error) {
                console.error('‚ùå Error verificando admin:', error);
                showNotification('‚ùå Error verificando permisos', 'error');
            }
        }

        // Cargar estad√≠sticas generales
        async function loadStats() {
            try {
                console.log('üìä Cargando estad√≠sticas...');
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('totalUsers').textContent = stats.users?.total || 0;
                document.getElementById('vipUsers').textContent = stats.users?.vip || 0;
                document.getElementById('trialRequests').textContent = stats.users?.trial_requests || 0;
                document.getElementById('pendingPaymentsCount').textContent = stats.payments?.pending || 0;
                document.getElementById('totalRevenue').textContent = stats.revenue?.total || 0;
                document.getElementById('trialPendingCount').textContent = stats.users?.trial_pending || 0;
                document.getElementById('totalReferrals').textContent = stats.referrals?.total || 0;
                document.getElementById('usdtPayments').textContent = stats.payments?.usdt || 0;
                document.getElementById('broadcastCount').textContent = stats.broadcasts?.total || 0;
                
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas:', error);
            }
        }

        // Cargar pagos pendientes
        async function loadPendingPayments() {
            try {
                document.getElementById('pendingLoading').style.display = 'block';
                document.getElementById('pendingTable').style.display = 'none';
                document.getElementById('pendingNoData').style.display = 'none';
                
                console.log('üîç Cargando pagos pendientes...');
                const response = await fetch('/api/payments/pending');
                const payments = await response.json();
                
                document.getElementById('pendingLoading').style.display = 'none';
                
                if (!payments || payments.length === 0) {
                    document.getElementById('pendingNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('pendingTableBody');
                tableBody.innerHTML = '';
                
                payments.forEach(payment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${payment.id || 'N/A'}</td>
                        <td>
                            <strong>${payment.user?.first_name || payment.user?.username || 'Usuario'}</strong><br>
                            <small>@${payment.user?.username || 'sin_usuario'}</small>
                        </td>
                        <td>${getPlanName(payment.plan)}</td>
                        <td>${getPaymentMethodBadge(payment.method)}</td>
                        <td>$${payment.price || 0} ${payment.method === 'usdt' ? 'USDT' : 'CUP'}</td>
                        <td>${payment.created_at ? new Date(payment.created_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                        <td><span class="badge pending">Pendiente</span></td>
                        <td>
                            ${payment.method !== 'usdt' ? 
                                `<button class="action-btn approve" onclick="viewScreenshot('${payment.id}', '${payment.telegram_id}', '${payment.plan}', '${payment.price}', '${payment.created_at}', '${payment.screenshot_url}')">
                                    <i class="fas fa-eye"></i> Ver
                                </button>` : 
                                `<button class="action-btn approve" onclick="approveUsdtPayment('${payment.id}')">
                                    <i class="fas fa-check"></i> Aprobar USDT
                                </button>`
                            }
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('pendingTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando pagos pendientes:', error);
                document.getElementById('pendingLoading').style.display = 'none';
                showNotification('‚ùå Error cargando pagos pendientes', 'error');
            }
        }

        // Cargar pruebas pendientes
        async function loadPendingTrials() {
            try {
                document.getElementById('trialLoading').style.display = 'block';
                document.getElementById('trialTable').style.display = 'none';
                document.getElementById('trialNoData').style.display = 'none';
                
                console.log('üéØ Cargando pruebas pendientes...');
                const response = await fetch('/api/trials/pending');
                const trials = await response.json();
                
                document.getElementById('trialLoading').style.display = 'none';
                
                if (!trials || trials.length === 0) {
                    document.getElementById('trialNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('trialTableBody');
                tableBody.innerHTML = '';
                
                trials.forEach(trial => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${trial.telegram_id || 'N/A'}</td>
                        <td>
                            <strong>${trial.first_name || trial.username || 'Usuario'}</strong><br>
                            <small>@${trial.username || 'sin_usuario'}</small>
                        </td>
                        <td>${trial.trial_info?.game_server || 'No especificado'}</td>
                        <td>${trial.trial_info?.connection_type || 'No especificado'}</td>
                        <td>${trial.trial_requested_at ? new Date(trial.trial_requested_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                        <td>
                            <button class="action-btn send-trial" onclick="sendTrialConfig('${trial.telegram_id}', '${trial.first_name || trial.username || 'Usuario'}')">
                                <i class="fas fa-gift"></i> Enviar
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('trialTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando pruebas pendientes:', error);
                document.getElementById('trialLoading').style.display = 'none';
                showNotification('‚ùå Error cargando pruebas pendientes', 'error');
            }
        }

        // Cargar pagos aprobados
        async function loadApprovedPayments() {
            try {
                document.getElementById('approvedLoading').style.display = 'block';
                document.getElementById('approvedTable').style.display = 'none';
                document.getElementById('approvedNoData').style.display = 'none';
                
                console.log('üîç Cargando pagos aprobados...');
                const response = await fetch('/api/payments/approved');
                const payments = await response.json();
                
                document.getElementById('approvedLoading').style.display = 'none';
                
                if (!payments || payments.length === 0) {
                    document.getElementById('approvedNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('approvedTableBody');
                tableBody.innerHTML = '';
                
                payments.forEach(payment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${payment.id || 'N/A'}</td>
                        <td>
                            <strong>${payment.user?.first_name || payment.user?.username || 'Usuario'}</strong><br>
                            <small>@${payment.user?.username || 'sin_usuario'}</small>
                        </td>
                        <td>${getPlanName(payment.plan)}</td>
                        <td>${getPaymentMethodBadge(payment.method)}</td>
                        <td>$${payment.price || 0} ${payment.method === 'usdt' ? 'USDT' : 'CUP'}</td>
                        <td>${payment.approved_at ? new Date(payment.approved_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                        <td>
                            ${payment.config_sent ? 
                                '<span class="badge approved">Enviada</span>' : 
                                '<span class="badge pending">Pendiente</span>'
                            }
                        </td>
                        <td>
                            ${!payment.config_sent ? 
                                `<button class="action-btn send-config" onclick="openConfigModal('${payment.id}', '${payment.telegram_id}', '${payment.plan}')">
                                    <i class="fas fa-paper-plane"></i> Enviar
                                </button>` : 
                                ''
                            }
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('approvedTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando pagos aprobados:', error);
                document.getElementById('approvedLoading').style.display = 'none';
                showNotification('‚ùå Error cargando pagos aprobados', 'error');
            }
        }

        // Cargar usuarios
        async function loadUsers() {
            try {
                document.getElementById('usersLoading').style.display = 'block';
                document.getElementById('usersTable').style.display = 'none';
                document.getElementById('usersNoData').style.display = 'none';
                
                console.log('üîç Cargando usuarios...');
                const response = await fetch('/api/all-users');
                const users = await response.json();
                
                document.getElementById('usersLoading').style.display = 'none';
                
                if (!users || users.length === 0) {
                    document.getElementById('usersNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('usersTableBody');
                tableBody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.telegram_id || 'N/A'}</td>
                        <td>${user.first_name || 'Usuario'}</td>
                        <td>@${user.username || 'sin_usuario'}</td>
                        <td>${user.current_plan ? getPlanName(user.current_plan) : 'Sin plan'}</td>
                        <td>${user.referrer_id ? '@' + (user.referrer_username || user.referrer_id) : 'Directo'}</td>
                        <td>${user.created_at ? new Date(user.created_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                        <td>
                            <button class="action-btn view-details" onclick="viewUserDetails('${user.telegram_id}')">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('usersTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando usuarios:', error);
                document.getElementById('usersLoading').style.display = 'none';
                showNotification('‚ùå Error cargando usuarios', 'error');
            }
        }

        // Cargar sistema de referidos
        async function loadReferrals() {
            try {
                document.getElementById('referralsListLoading').style.display = 'block';
                document.getElementById('topReferrersLoading').style.display = 'block';
                
                console.log('ü§ù Cargando sistema de referidos...');
                
                // Cargar estad√≠sticas generales
                const statsResponse = await fetch('/api/referrals/stats');
                const stats = await statsResponse.json();
                
                document.getElementById('totalReferralsCount').textContent = stats.total_referrals || 0;
                document.getElementById('paidReferrals').textContent = stats.paid_referrals || 0;
                document.getElementById('level1Referrals').textContent = stats.level1_referrals || 0;
                document.getElementById('level2Referrals').textContent = stats.level2_referrals || 0;
                
                // Calcular descuentos
                const level1Discount = (stats.paid_level1 || 0) * 20;
                const level2Discount = (stats.paid_level2 || 0) * 10;
                document.getElementById('level1Discount').textContent = level1Discount + '%';
                document.getElementById('level2Discount').textContent = level2Discount + '%';
                
                // Cargar top referidores
                const topResponse = await fetch('/api/referrals/top');
                const topReferrers = await topResponse.json();
                
                document.getElementById('topReferrersLoading').style.display = 'none';
                
                const topTableBody = document.getElementById('topReferrersTableBody');
                topTableBody.innerHTML = '';
                
                if (topReferrers && topReferrers.length > 0) {
                    topReferrers.forEach(referrer => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <strong>${referrer.first_name || 'Usuario'}</strong><br>
                                <small>@${referrer.username || 'sin_usuario'}</small>
                            </td>
                            <td>${referrer.total_referrals || 0}</td>
                            <td>${referrer.paid_referrals || 0}</td>
                            <td>${(referrer.paid_referrals || 0) * 20}%</td>
                        `;
                        topTableBody.appendChild(row);
                    });
                }
                
                // Cargar lista completa de referidos
                const listResponse = await fetch('/api/referrals/list');
                const referralsList = await listResponse.json();
                
                document.getElementById('referralsListLoading').style.display = 'none';
                
                const listTableBody = document.getElementById('referralsListTableBody');
                listTableBody.innerHTML = '';
                
                if (referralsList && referralsList.length > 0) {
                    referralsList.forEach(referral => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <strong>${referral.user_name || 'Usuario'}</strong><br>
                                <small>ID: ${referral.user_id || 'N/A'}</small>
                            </td>
                            <td>
                                ${referral.referrer_name ? 
                                    `<strong>${referral.referrer_name}</strong><br>
                                     <small>ID: ${referral.referrer_id || 'N/A'}</small>` : 
                                    'Directo'
                                }
                            </td>
                            <td>
                                ${referral.level === 1 ? 
                                    '<span class="badge referral-level-1">Nivel 1</span>' : 
                                    '<span class="badge referral-level-2">Nivel 2</span>'
                                }
                            </td>
                            <td>${getPlanName(referral.plan) || 'Sin plan'}</td>
                            <td>
                                ${referral.has_paid ? 
                                    '<span class="badge paid">Pagado</span>' : 
                                    '<span class="badge unpaid">No pagado</span>'
                                }
                            </td>
                            <td>
                                ${referral.has_paid ? 
                                    (referral.level === 1 ? '20%' : '10%') : 
                                    '0%'
                                }
                            </td>
                            <td>${referral.referred_at ? new Date(referral.referred_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                        `;
                        listTableBody.appendChild(row);
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando sistema de referidos:', error);
                document.getElementById('referralsListLoading').style.display = 'none';
                document.getElementById('topReferrersLoading').style.display = 'none';
                showNotification('‚ùå Error cargando sistema de referidos', 'error');
            }
        }

        // Cargar archivos de planes
        async function loadPlanFiles() {
            try {
                console.log('üìÅ Cargando archivos de planes...');
                const response = await fetch('/api/plan-files');
                const planFiles = await response.json();
                
                // Mostrar √°rea de carga mientras se obtienen los datos
                document.getElementById('basicPlanFile').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                document.getElementById('advancedPlanFile').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                document.getElementById('premiumPlanFile').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                document.getElementById('annualPlanFile').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                
                // Actualizar informaci√≥n de cada plan
                if (planFiles && Array.isArray(planFiles)) {
                    planFiles.forEach(file => {
                        const planFileElement = document.getElementById(`${file.plan}PlanFile`);
                        const planDateElement = document.getElementById(`${file.plan}PlanDate`);
                        
                        if (planFileElement) {
                            planFileElement.textContent = file.filename || 'No subido';
                        }
                        if (planDateElement) {
                            planDateElement.textContent = file.updated_at ? 
                                new Date(file.updated_at).toLocaleDateString('es-ES') : 'N/A';
                        }
                    });
                } else {
                    console.warn('‚ö†Ô∏è No se recibieron datos de archivos de planes');
                    // Resetear a valores por defecto
                    document.getElementById('basicPlanFile').textContent = 'No subido';
                    document.getElementById('advancedPlanFile').textContent = 'No subido';
                    document.getElementById('premiumPlanFile').textContent = 'No subido';
                    document.getElementById('annualPlanFile').textContent = 'No subido';
                    
                    document.getElementById('basicPlanDate').textContent = 'N/A';
                    document.getElementById('advancedPlanDate').textContent = 'N/A';
                    document.getElementById('premiumPlanDate').textContent = 'N/A';
                    document.getElementById('annualPlanDate').textContent = 'N/A';
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando archivos de planes:', error);
                showNotification('‚ùå Error cargando archivos de planes', 'error');
                
                // En caso de error, mostrar valores por defecto
                document.getElementById('basicPlanFile').textContent = 'Error cargando';
                document.getElementById('advancedPlanFile').textContent = 'Error cargando';
                document.getElementById('premiumPlanFile').textContent = 'Error cargando';
                document.getElementById('annualPlanFile').textContent = 'Error cargando';
            }
        }

        // Abrir upload de archivo para plan - CORREGIDA
        function openPlanFileUpload(plan) {
            currentPlanForUpload = plan;
            const fileInputId = plan + 'PlanFileInput';
            
            // Limpiar el input primero para permitir subir el mismo archivo otra vez
            const fileInput = document.getElementById(fileInputId);
            if (fileInput) {
                fileInput.value = '';
                
                // Disparar el click en el input de archivo
                fileInput.click();
            } else {
                console.error(`‚ùå No se encontr√≥ el input con ID: ${fileInputId}`);
                showNotification('‚ùå Error al abrir el selector de archivos', 'error');
            }
        }

        // Subir archivo de plan - CORREGIDA
        async function uploadPlanFile(event) {
            if (!currentPlanForUpload) {
                showNotification('‚ùå Selecciona un plan primero', 'warning');
                return;
            }
            
            const fileInputId = currentPlanForUpload + 'PlanFileInput';
            const fileInput = document.getElementById(fileInputId);
            
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showNotification('‚ùå No se seleccion√≥ ning√∫n archivo', 'warning');
                return;
            }
            
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('‚ùå Selecciona un archivo v√°lido', 'warning');
                return;
            }
            
            // Validar que sea ZIP, RAR o CONF
            const fileName = file.name.toLowerCase();
            const isValidFile = fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.conf');
            
            if (!isValidFile) {
                showNotification('‚ùå Solo se permiten archivos .conf, .zip o .rar', 'warning');
                fileInput.value = ''; // Limpiar el input
                return;
            }
            
            // Validar tama√±o del archivo (m√°ximo 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB en bytes
            if (file.size > maxSize) {
                showNotification('‚ùå El archivo es demasiado grande (m√°ximo 10MB)', 'warning');
                fileInput.value = '';
                return;
            }
            
            console.log(`üì§ Subiendo archivo ${file.name} (${formatBytes(file.size)}) para plan ${currentPlanForUpload}...`);
            
            // Mostrar mensaje de carga
            showNotification(`‚è≥ Subiendo archivo ${file.name}...`, 'info');
            
            const formData = new FormData();
            formData.append('plan', currentPlanForUpload);
            formData.append('file', file);
            formData.append('adminId', currentUserId);
            
            try {
                const response = await fetch('/api/upload-plan-file', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`‚úÖ Archivo subido correctamente para plan ${getPlanName(currentPlanForUpload)}`, 'success');
                    
                    // Actualizar la visualizaci√≥n inmediatamente
                    const planFileElement = document.getElementById(`${currentPlanForUpload}PlanFile`);
                    const planDateElement = document.getElementById(`${currentPlanForUpload}PlanDate`);
                    
                    if (planFileElement) {
                        planFileElement.textContent = file.name;
                    }
                    if (planDateElement) {
                        planDateElement.textContent = new Date().toLocaleDateString('es-ES');
                    }
                    
                    // Recargar la lista completa de archivos
                    setTimeout(() => {
                        loadPlanFiles();
                    }, 1000);
                    
                } else {
                    throw new Error(result.error || 'Error subiendo archivo');
                }
            } catch (error) {
                console.error('‚ùå Error subiendo archivo de plan:', error);
                showNotification('‚ùå Error subiendo archivo: ' + error.message, 'error');
            } finally {
                // Resetear el input y la variable
                if (fileInput) {
                    fileInput.value = '';
                }
                currentPlanForUpload = null;
            }
        }

        // Funci√≥n auxiliar para formatear bytes
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Cargar estad√≠sticas de juegos
        async function loadGamesStats() {
            try {
                document.getElementById('gamesLoading').style.display = 'block';
                document.getElementById('gamesTable').style.display = 'none';
                document.getElementById('gamesNoData').style.display = 'none';
                
                console.log('üéÆ Cargando estad√≠sticas de juegos...');
                const response = await fetch('/api/games-stats');
                const games = await response.json();
                
                document.getElementById('gamesLoading').style.display = 'none';
                
                if (!games || games.length === 0) {
                    document.getElementById('gamesNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('gamesTableBody');
                tableBody.innerHTML = '';
                
                games.forEach(game => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${game.game_server || 'No especificado'}</td>
                        <td>${game.request_count || 0}</td>
                        <td>${game.connection_types?.join(', ') || 'No especificado'}</td>
                        <td>${game.last_request ? new Date(game.last_request).toLocaleDateString('es-ES') : 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('gamesTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas de juegos:', error);
                document.getElementById('gamesLoading').style.display = 'none';
                showNotification('‚ùå Error cargando estad√≠sticas de juegos', 'error');
            }
        }

        // Cargar historial de broadcasts
        async function loadBroadcasts() {
            try {
                document.getElementById('broadcastLoading').style.display = 'block';
                document.getElementById('broadcastTable').style.display = 'none';
                document.getElementById('broadcastNoData').style.display = 'none';
                
                console.log('üì¢ Cargando historial de broadcasts...');
                const response = await fetch('/api/broadcasts');
                const broadcasts = await response.json();
                
                document.getElementById('broadcastLoading').style.display = 'none';
                
                if (!broadcasts || broadcasts.length === 0) {
                    document.getElementById('broadcastNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('broadcastTableBody');
                tableBody.innerHTML = '';
                
                broadcasts.forEach(broadcast => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${broadcast.id || 'N/A'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${broadcast.message}">
                            ${truncateText(broadcast.message, 50)}
                        </td>
                        <td>${getBroadcastTargetName(broadcast.target)}</td>
                        <td>${broadcast.sent_count || 0}/${broadcast.total_users || 0}</td>
                        <td>
                            ${broadcast.status === 'completed' ? 
                                '<span class="badge completed">Completado</span>' : 
                                '<span class="badge pending">Pendiente</span>'
                            }
                        </td>
                        <td>${broadcast.created_at ? new Date(broadcast.created_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('broadcastTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando broadcasts:', error);
                document.getElementById('broadcastLoading').style.display = 'none';
                showNotification('‚ùå Error cargando broadcasts', 'error');
            }
        }

        // Enviar broadcast
        async function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            const target = document.getElementById('broadcastTarget').value;
            
            if (!message) {
                showNotification('‚ùå Escribe un mensaje para enviar', 'warning');
                return;
            }
            
            if (!confirm(`¬øEst√°s seguro de enviar este broadcast a ${getBroadcastTargetName(target)}?`)) {
                return;
            }
            
            const button = document.getElementById('broadcastButton');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            
            try {
                const response = await fetch('/api/broadcast/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        target: target,
                        adminId: currentUserId
                    })
                });
                
                if (response.ok) {
                    showNotification('‚úÖ Broadcast enviado correctamente', 'success');
                    document.getElementById('broadcastMessage').value = '';
                    loadBroadcasts();
                } else {
                    throw new Error('Error enviando broadcast');
                }
            } catch (error) {
                console.error('‚ùå Error enviando broadcast:', error);
                showNotification('‚ùå Error enviando broadcast: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Broadcast';
            }
        }

        // Ver captura de pantalla
        function viewScreenshot(paymentId, telegramId, plan, amount, date, screenshotUrl) {
            currentPaymentId = paymentId;
            
            document.getElementById('screenshotImage').src = screenshotUrl;
            document.getElementById('modalUserId').textContent = telegramId;
            document.getElementById('modalPlan').textContent = getPlanName(plan);
            document.getElementById('modalAmount').textContent = amount;
            document.getElementById('modalDate').textContent = new Date(date).toLocaleDateString('es-ES');
            
            document.getElementById('screenshotModal').classList.add('active');
        }

        // Abrir modal de configuraci√≥n
        function openConfigModal(paymentId, telegramId, plan) {
            currentPaymentId = paymentId;
            
            document.getElementById('configPaymentId').textContent = paymentId;
            document.getElementById('configUserId').textContent = telegramId;
            document.getElementById('configPlan').textContent = getPlanName(plan);
            
            document.getElementById('configModal').classList.add('active');
        }

        // Enviar configuraci√≥n de prueba
        async function sendTrialConfig(telegramId, userName) {
            if (!confirm(`¬øEnviar configuraci√≥n de prueba a ${userName}?`)) return;
            
            try {
                const response = await fetch('/api/send-trial-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegramId: telegramId,
                        adminId: currentUserId
                    })
                });
                
                if (response.ok) {
                    showNotification(`‚úÖ Configuraci√≥n de prueba enviada a ${userName}`, 'success');
                    loadPendingTrials();
                } else {
                    throw new Error('Error enviando configuraci√≥n de prueba');
                }
            } catch (error) {
                console.error('‚ùå Error enviando configuraci√≥n de prueba:', error);
                showNotification('‚ùå Error enviando configuraci√≥n de prueba', 'error');
            }
        }

        // Aprobar pago USDT
        async function approveUsdtPayment(paymentId) {
            if (!confirm('¬øAprobar este pago USDT?')) return;
            
            try {
                const response = await fetch(`/api/payments/${paymentId}/approve-usdt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminId: currentUserId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showNotification('‚úÖ Pago USDT aprobado. Se enviar√° el archivo autom√°ticamente.', 'success');
                    loadPendingPayments();
                    loadApprovedPayments();
                    loadStats();
                } else {
                    throw new Error('Error aprobando pago USDT');
                }
            } catch (error) {
                console.error('‚ùå Error aprobando pago USDT:', error);
                showNotification('‚ùå Error aprobando pago USDT', 'error');
            }
        }

        // Aprobar pago
        async function approvePayment(paymentId) {
            if (!confirm('¬øEst√°s seguro de aprobar este pago?')) return;
            
            try {
                const response = await fetch(`/api/payments/${paymentId}/approve`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showNotification('‚úÖ Pago aprobado correctamente', 'success');
                    closeModal();
                    loadPendingPayments();
                    loadApprovedPayments();
                    loadStats();
                } else {
                    throw new Error('Error aprobando pago');
                }
            } catch (error) {
                console.error('‚ùå Error aprobando pago:', error);
                showNotification('‚ùå Error aprobando pago', 'error');
            }
        }

        // Rechazar pago
        async function rejectPayment(paymentId) {
            const reason = prompt('Ingresa el motivo del rechazo:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/payments/${paymentId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    showNotification('‚úÖ Pago rechazado correctamente', 'success');
                    closeModal();
                    loadPendingPayments();
                    loadStats();
                } else {
                    throw new Error('Error rechazando pago');
                }
            } catch (error) {
                console.error('‚ùå Error rechazando pago:', error);
                showNotification('‚ùå Error rechazando pago', 'error');
            }
        }

        // Enviar archivo de configuraci√≥n
        async function sendConfigFile() {
            const fileInput = document.getElementById('configFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('‚ùå Selecciona un archivo de configuraci√≥n', 'warning');
                return;
            }
            
            // Validar que sea ZIP, RAR o CONF
            const fileName = file.name.toLowerCase();
            const isValidFile = fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.conf');
            
            if (!isValidFile) {
                showNotification('‚ùå Solo se permiten archivos .conf, .zip o .rar', 'warning');
                fileInput.value = '';
                return;
            }
            
            const formData = new FormData();
            formData.append('configFile', file);
            formData.append('paymentId', currentPaymentId);
            formData.append('adminId', currentUserId);
            
            try {
                showNotification('‚è≥ Enviando configuraci√≥n...', 'info');
                
                const response = await fetch('/api/send-config', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showNotification('‚úÖ Configuraci√≥n enviada correctamente', 'success');
                    closeConfigModal();
                    loadApprovedPayments();
                    fileInput.value = '';
                } else {
                    throw new Error('Error enviando configuraci√≥n');
                }
            } catch (error) {
                console.error('‚ùå Error enviando configuraci√≥n:', error);
                showNotification('‚ùå Error enviando configuraci√≥n', 'error');
            }
        }

        // Ver detalles de usuario
        async function viewUserDetails(telegramId) {
            try {
                const response = await fetch(`/api/user/${telegramId}/details`);
                const user = await response.json();
                
                const details = `üë§ *Detalles del Usuario*\n\n` +
                    `*ID:* ${user.telegram_id}\n` +
                    `*Nombre:* ${user.first_name}\n` +
                    `*Usuario:* @${user.username}\n` +
                    `*Plan actual:* ${getPlanName(user.current_plan)}\n` +
                    `*Referidor:* ${user.referrer_id ? '@' + user.referrer_username : 'Directo'}\n` +
                    `*Referidos directos:* ${user.level1_referrals || 0}\n` +
                    `*Referidos nivel 2:* ${user.level2_referrals || 0}\n` +
                    `*Descuento aplicable:* ${((user.level1_paid || 0) * 20) + ((user.level2_paid || 0) * 10)}%\n` +
                    `*Registro:* ${new Date(user.created_at).toLocaleDateString('es-ES')}`;
                
                showNotification(details, 'info');
            } catch (error) {
                console.error('‚ùå Error obteniendo detalles de usuario:', error);
                showNotification('‚ùå Error obteniendo detalles del usuario', 'error');
            }
        }

        // Cerrar modales
        function closeModal() {
            document.getElementById('screenshotModal').classList.remove('active');
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
            document.getElementById('configFile').value = '';
        }

        // Mostrar notificaci√≥n
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, type === 'error' ? 10000 : 5000);
        }

        // Cambiar pesta√±as
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.getElementById(tabName + 'Content').style.display = 'block';
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            currentTab = tabName;
            
            switch(tabName) {
                case 'pending':
                    loadPendingPayments();
                    break;
                case 'trial-pending':
                    loadPendingTrials();
                    break;
                case 'approved':
                    loadApprovedPayments();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'referrals':
                    loadReferrals();
                    break;
                case 'plan-files':
                    loadPlanFiles();
                    break;
                case 'games':
                    loadGamesStats();
                    break;
                case 'broadcast':
                    loadBroadcasts();
                    break;
                case 'stats':
                    loadStats();
                    break;
            }
        }

        // Obtener nombre del plan
        function getPlanName(planType) {
            const plans = {
                'basico': 'B√°sico (1 mes)',
                'avanzado': 'Avanzado (2 meses)',
                'premium': 'Premium (1 mes)',
                'anual': 'Anual (12 meses)'
            };
            return plans[planType] || planType;
        }

        // Obtener badge de m√©todo de pago
        function getPaymentMethodBadge(method) {
            const badges = {
                'transfer': '<span class="badge">BPA</span>',
                'metropolitan': '<span class="badge">Metropolitana</span>',
                'mitransfer': '<span class="badge">MITRANSFER</span>',
                'mobile': '<span class="badge">Saldo M√≥vil</span>',
                'usdt': '<span class="badge usdt">USDT</span>'
            };
            return badges[method] || `<span class="badge">${method}</span>`;
        }

        // Obtener nombre del target de broadcast
        function getBroadcastTargetName(target) {
            const targets = {
                'all': 'üë• Todos los usuarios',
                'vip': 'üëë Solo usuarios VIP',
                'non_vip': 'üë§ Usuarios no VIP',
                'trial_pending': '‚è≥ Pruebas pendientes',
                'trial_received': '‚úÖ Pruebas recibidas',
                'active': 'üì± Usuarios activos',
                'with_referrals': 'ü§ù Con referidos',
                'usdt_payers': 'üí∞ Pagaron con USDT'
            };
            return targets[target] || target;
        }

        // Truncar texto
        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // Manejar el cambio en inputs de archivo - NUEVA FUNCI√ìN
        function handleFileInputChange(event) {
            const input = event.target;
            if (input.files && input.files.length > 0) {
                // Extraer el plan del ID del input
                const inputId = input.id;
                let plan = '';
                
                if (inputId.includes('basic')) plan = 'basico';
                else if (inputId.includes('advanced')) plan = 'avanzado';
                else if (inputId.includes('premium')) plan = 'premium';
                else if (inputId.includes('annual')) plan = 'anual';
                
                if (plan) {
                    currentPlanForUpload = plan;
                    uploadPlanFile(event);
                } else {
                    console.error('‚ùå No se pudo determinar el plan del input:', inputId);
                    showNotification('‚ùå Error al determinar el plan', 'error');
                }
            }
        }

        // Configurar eventos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeConfigModal();
            }
        });

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ Panel de administraci√≥n cargado');
            
            checkAdminAccess();
            
            // Configurar eventos de pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Configurar eventos de cambio para cada input de archivo
            const fileInputs = [
                'basicPlanFileInput',
                'advancedPlanFileInput', 
                'premiumPlanFileInput',
                'annualPlanFileInput'
            ];
            
            fileInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // Remover cualquier listener previo para evitar duplicados
                    const newInput = input.cloneNode(true);
                    input.parentNode.replaceChild(newInput, input);
                    
                    // Agregar nuevo listener
                    document.getElementById(inputId).addEventListener('change', handleFileInputChange);
                }
            });
            
            // Auto-refresh cada 30 segundos
            setInterval(() => {
                if (currentTab === 'stats') {
                    loadStats();
                }
            }, 30000);
        });
    </script>
</body>
</html>
