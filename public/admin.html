<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN Cuba - Panel de Administraci√≥n</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* VARIABLES Y RESET */
        :root {
            --primary: #0a0a1f;
            --secondary: #121230;
            --accent: #4f46e5;
            --accent-light: #6366f1;
            --accent-glow: rgba(79, 70, 229, 0.4);
            --text: #ffffff;
            --text-secondary: #a5b4fc;
            --card-bg: rgba(18, 18, 48, 0.9);
            --border: rgba(99, 102, 241, 0.2);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --trial: #10b981;
            --trial-light: #34d399;
            --trial-glow: rgba(16, 185, 129, 0.4);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --game-color: #8b5cf6;
            --connection-color: #3b82f6;
            --broadcast-color: #8b5cf6;
            --broadcast-glow: rgba(139, 92, 246, 0.4);
            --referral-color: #8b5cf6;
            --usdt-color: #f0b90b;
            --annual-green: #39ff14;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* CONTAINER */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        .header {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 40px;
            border-bottom: 2px solid rgba(79, 70, 229, 0.3);
        }

        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--accent);
            margin-right: 15px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #a5b4fc 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        /* CARDS */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* ESTAD√çSTICAS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .stat-card.users .stat-value { color: var(--accent); }
        .stat-card.users .stat-icon { color: var(--accent); }
        
        .stat-card.vip .stat-value { color: var(--warning); }
        .stat-card.vip .stat-icon { color: var(--warning); }
        
        .stat-card.trial .stat-value { color: var(--trial); }
        .stat-card.trial .stat-icon { color: var(--trial); }
        
        .stat-card.revenue .stat-value { color: var(--success); }
        .stat-card.revenue .stat-icon { color: var(--success); }
        
        .stat-card.pending .stat-value { color: var(--warning); }
        .stat-card.pending .stat-icon { color: var(--warning); }

        .stat-card.trial-pending .stat-value { color: var(--trial-light); }
        .stat-card.trial-pending .stat-icon { color: var(--trial-light); }

        .stat-card.games .stat-value { color: var(--game-color); }
        .stat-card.games .stat-icon { color: var(--game-color); }
        
        .stat-card.connections .stat-value { color: var(--connection-color); }
        .stat-card.connections .stat-icon { color: var(--connection-color); }

        .stat-card.broadcast .stat-value { color: var(--broadcast-color); }
        .stat-card.broadcast .stat-icon { color: var(--broadcast-color); }

        .stat-card.referrals .stat-value { color: var(--referral-color); }
        .stat-card.referrals .stat-icon { color: var(--referral-color); }

        .stat-card.usdt .stat-value { color: var(--usdt-color); }
        .stat-card.usdt .stat-icon { color: var(--usdt-color); }

        /* TABLAS */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(79, 70, 229, 0.2);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* BADGES */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge.approved {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge.vip {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .badge.trial {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.trial-pending {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.3);
            animation: pulse 2s infinite;
        }

        .badge.non-vip {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .badge.game {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .badge.connection {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge.broadcast {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .badge.sending {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
            animation: pulse 1.5s infinite;
        }

        .badge.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.failed {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge.referral-level-1 {
            background: rgba(139, 92, 246, 0.3);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.4);
        }

        .badge.referral-level-2 {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.25);
        }

        .badge.paid {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.unpaid {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .badge.usdt {
            background: rgba(240, 185, 11, 0.2);
            color: #f0b90b;
            border: 1px solid rgba(240, 185, 11, 0.3);
        }

        .badge.annual {
            background: rgba(57, 255, 20, 0.2);
            color: var(--annual-green);
            border: 1px solid rgba(57, 255, 20, 0.3);
        }

        .badge.trial-file {
            background: rgba(16, 185, 129, 0.2);
            color: var(--trial-light);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* BOTONES DE ACCI√ìN */
        .action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .action-btn.approve {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .action-btn.approve:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .action-btn.reject {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .action-btn.reject:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .action-btn.send-config {
            background: rgba(79, 70, 229, 0.2);
            color: var(--accent-light);
            border: 1px solid rgba(79, 70, 229, 0.3);
        }

        .action-btn.send-config:hover {
            background: rgba(79, 70, 229, 0.3);
        }

        .action-btn.message {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .action-btn.message:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .action-btn.remove-vip {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .action-btn.remove-vip:hover {
            background: rgba(245, 158, 11, 0.3);
        }

        .action-btn.send-trial {
            background: rgba(16, 185, 129, 0.2);
            color: var(--trial-light);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .action-btn.send-trial:hover {
            background: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 15px var(--trial-glow);
        }

        .action-btn.send-broadcast {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .action-btn.send-broadcast:hover {
            background: rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 15px var(--broadcast-glow);
        }

        .action-btn.view-details {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent-light);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .action-btn.view-details:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .screenshot-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .config-form {
            margin-top: 20px;
        }

        .file-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text);
            margin-bottom: 15px;
        }

        .submit-config {
            width: 100%;
            padding: 15px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-config:hover {
            background: var(--accent-light);
        }

        .submit-trial {
            width: 100%;
            padding: 15px;
            background: var(--trial);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-trial:hover {
            background: var(--trial-light);
            box-shadow: 0 0 20px var(--trial-glow);
        }

        .submit-broadcast {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--broadcast-color) 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-broadcast:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--broadcast-glow);
        }

        .submit-broadcast:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .card {
                padding: 20px;
            }
            
            th, td {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .action-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                margin-right: 4px;
            }
        }

        /* NOTIFICACI√ìN */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--card-bg);
            border: 1px solid;
            border-radius: 12px;
            color: var(--text);
            font-weight: 500;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .notification.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .notification.warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }

        .notification.info {
            border-color: var(--accent);
            background: rgba(79, 70, 229, 0.1);
        }
        
        /* SECCI√ìN DE REFERIDOS */
        .referrals-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .referral-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .referral-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
        }
        
        .referral-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .referral-stat {
            text-align: center;
            padding: 10px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
        }
        
        .referral-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #a78bfa;
            margin-bottom: 5px;
        }
        
        .referral-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .referral-discount {
            background: rgba(139, 92, 246, 0.15);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .discount-title {
            font-size: 1rem;
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 8px;
        }
        
        .discount-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .discount-level {
            color: var(--text-secondary);
        }
        
        .discount-percent {
            color: #34d399;
            font-weight: 600;
        }
        
        /* PANEL DE ARCHIVOS DE PLANES */
        .plan-files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .plan-file-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .plan-file-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .plan-file-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .plan-file-badge {
            background: rgba(79, 70, 229, 0.2);
            color: var(--accent-light);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .plan-file-info {
            margin-bottom: 15px;
        }
        
        .plan-file-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .plan-file-label {
            color: var(--text-secondary);
        }
        
        .plan-file-value {
            color: var(--text);
            font-weight: 500;
        }
        
        .file-upload-area {
            border: 2px dashed rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .file-upload-area:hover {
            border-color: rgba(79, 70, 229, 0.6);
            background: rgba(79, 70, 229, 0.05);
        }
        
        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .file-upload-text {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
        }
        
        .file-upload-subtext {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        /* INFO BOX */
        .info-box {
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
            color: var(--trial-light);
            font-size: 0.9rem;
        }

        .info-box i {
            margin-right: 10px;
            color: var(--trial-light);
        }

        .info-box.broadcast {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .info-box.broadcast i {
            color: #a78bfa;
        }
        
        .info-box.referral {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }
        
        .info-box.referral i {
            color: #a78bfa;
        }
        
        .info-box.usdt {
            background: rgba(240, 185, 11, 0.1);
            border: 1px solid rgba(240, 185, 11, 0.2);
            color: #f0b90b;
        }
        
        .info-box.usdt i {
            color: #f0b90b;
        }

        .info-box.trial-files {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: var(--trial-light);
        }
        
        .info-box.trial-files i {
            color: var(--trial-light);
        }

        /* PROGRESS BAR */
        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .progress-text {
            color: var(--text-secondary);
        }

        .progress-percent {
            color: var(--text);
            font-weight: 600;
        }

        /* FORMULARIOS */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 500;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            font-family: inherit;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .form-textarea {
            width: 100%;
            padding: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            font-family: inherit;
            min-height: 150px;
            resize: vertical;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        /* STATS GRID */
        .stats-mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stat-mini {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            text-align: center;
        }

        .stat-mini-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-mini-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* BROADCAST PROGRESS */
        .broadcast-progress {
            padding: 20px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .broadcast-progress.active {
            display: block;
        }

        .broadcast-progress-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .broadcast-progress-title {
            font-weight: 600;
            color: var(--text);
        }

        .broadcast-progress-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        /* BADGE ANUAL */
        .plan-file-badge.anual {
            background: rgba(57, 255, 20, 0.2);
            color: var(--annual-green);
            border: 1px solid rgba(57, 255, 20, 0.3);
        }
        
        /* BUSCADOR DE REFERIDOS */
        .search-form {
            padding: 20px;
        }
        
        .user-info-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 12px;
        }
        
        .referral-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-mini {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(139, 92, 246, 0.2);
            transition: transform 0.3s ease;
        }
        
        .stat-mini:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.2);
        }
        
        .stat-mini-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #a78bfa;
        }
        
        .stat-mini-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        #referralsPagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .pagination-btn {
            padding: 8px 16px;
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.3);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ESTILOS PARA ARCHIVOS DE PRUEBA */
        .trial-file-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(16, 185, 129, 0.2);
            margin-bottom: 20px;
        }
        
        .trial-file-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .trial-file-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ESTILOS PARA MODAL DE DETALLES DE USUARIO */
        .user-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .user-detail-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .user-detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }
        
        /* ESTILOS PARA INPUTS DE B√öSQUEDA */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            font-family: inherit;
        }
        
        .search-button {
            padding: 12px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        /* ESTILOS PARA PAGINACI√ìN */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .page-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
        }
        
        .page-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ESTILOS ADICIONALES PARA ESTAD√çSTICAS DE ARCHIVOS */
        .stat-card.file-stats {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .stat-card.file-stats:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .stat-card.file-stats:nth-child(1) {
            border-color: rgba(79, 70, 229, 0.3);
        }

        .stat-card.file-stats:nth-child(2) {
            border-color: rgba(16, 185, 129, 0.3);
        }

        .stat-card.file-stats:nth-child(3) {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .stat-card.file-stats:nth-child(4) {
            border-color: rgba(139, 92, 246, 0.3);
        }

        /* Progress bar colors */
        .progress-fill.high-usage {
            background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
        }

        .progress-fill.medium-usage {
            background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
        }

        .progress-fill.low-usage {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
        }

        /* Badge para m√©todos de entrega */
        .badge.auto {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge.manual {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        /* FILENAME DISPLAY */
        .filename-display {
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
            word-break: break-all;
            font-size: 0.9rem;
        }
        
        .file-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .file-info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
        }
        
        .file-info-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }
        
        .file-info-value {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="header">
            <div class="logo-container">
                <i class="fas fa-shield-alt logo-icon"></i>
                <h1 class="title">VPN CUBA ADMIN</h1>
            </div>
            <p class="subtitle">Panel de administraci√≥n - Gesti√≥n de usuarios, pagos, referidos y archivos de planes</p>
        </header>

        <!-- TABS - ACTUALIZADAS -->
        <div class="tabs">
            <div class="tab active" data-tab="stats">üìä Estad√≠sticas</div>
            <div class="tab" data-tab="pending">‚è≥ Pagos Pendientes</div>
            <div class="tab" data-tab="trial-pending">üéØ Pruebas Pendientes</div>
            <div class="tab" data-tab="approved">‚úÖ Pagos Aprobados</div>
            <div class="tab" data-tab="users">üë• Usuarios</div>
            <div class="tab" data-tab="referrals">ü§ù Referidos</div>
            <div class="tab" data-tab="plan-files">üìÅ Archivos de Planes</div>
            <div class="tab" data-tab="games">üéÆ Juegos/Servidores</div>
            <div class="tab" data-tab="broadcast">üì¢ Broadcast</div>
        </div>

        <!-- ESTAD√çSTICAS - ACTUALIZADAS -->
        <div id="statsContent" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card users">
                    <i class="fas fa-users stat-icon"></i>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Usuarios Totales</div>
                </div>
                
                <div class="stat-card vip">
                    <i class="fas fa-crown stat-icon"></i>
                    <div class="stat-value" id="vipUsers">0</div>
                    <div class="stat-label">Usuarios VIP</div>
                </div>
                
                <div class="stat-card trial">
                    <i class="fas fa-gift stat-icon"></i>
                    <div class="stat-value" id="trialRequests">0</div>
                    <div class="stat-label">Solicitudes de Prueba</div>
                </div>
                
                <div class="stat-card trial-pending">
                    <i class="fas fa-clock stat-icon"></i>
                    <div class="stat-value" id="trialPendingCount">0</div>
                    <div class="stat-label">Pruebas Pendientes</div>
                </div>
                
                <div class="stat-card pending">
                    <i class="fas fa-clock stat-icon"></i>
                    <div class="stat-value" id="pendingPaymentsCount">0</div>
                    <div class="stat-label">Pagos Pendientes</div>
                </div>
                
                <div class="stat-card revenue">
                    <i class="fas fa-money-bill-wave stat-icon"></i>
                    <div class="stat-value" id="totalRevenue">0</div>
                    <div class="stat-label">Ingresos Totales (CUP)</div>
                </div>
                
                <div class="stat-card referrals">
                    <i class="fas fa-users stat-icon"></i>
                    <div class="stat-value" id="totalReferrals">0</div>
                    <div class="stat-label">Referidos Totales</div>
                </div>
                
                <div class="stat-card usdt">
                    <i class="fab fa-usd stat-icon"></i>
                    <div class="stat-value" id="usdtPayments">0</div>
                    <div class="stat-label">Pagos USDT</div>
                </div>

                <div class="stat-card broadcast">
                    <i class="fas fa-bullhorn stat-icon"></i>
                    <div class="stat-value" id="broadcastCount">0</div>
                    <div class="stat-label">Broadcasts Enviados</div>
                </div>
            </div>
        </div>

        <!-- PAGOS PENDIENTES -->
        <div id="pendingContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-clock"></i>
                        Pagos Pendientes
                    </h2>
                    <button class="refresh-btn" onclick="loadPendingPayments()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <div class="loading" id="pendingLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando pagos pendientes...</p>
                </div>
                
                <div class="table-container">
                    <table id="pendingTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Plan</th>
                                <th>M√©todo</th>
                                <th>Monto</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="pendingNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay pagos pendientes</p>
                </div>
            </div>
        </div>

        <!-- PRUEBAS PENDIENTES -->
        <div id="trial-pendingContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-gift"></i>
                        Pruebas Pendientes
                    </h2>
                    <button class="refresh-btn" onclick="loadPendingTrials()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    Estos usuarios solicitaron una prueba gratuita y est√°n esperando el archivo de configuraci√≥n.
                </div>
                
                <div class="loading" id="trialLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando pruebas pendientes...</p>
                </div>
                
                <div class="table-container">
                    <table id="trialTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>üéÆ Juego/Servidor</th>
                                <th>üì° Conexi√≥n</th>
                                <th>Solicitado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="trialTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="trialNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay pruebas pendientes</p>
                </div>
            </div>
        </div>

        <!-- PAGOS APROBADOS -->
        <div id="approvedContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-check-circle"></i>
                        Pagos Aprobados
                    </h2>
                    <button class="refresh-btn" onclick="loadApprovedPayments()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <div class="loading" id="approvedLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando pagos aprobados...</p>
                </div>
                
                <div class="table-container">
                    <table id="approvedTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Plan</th>
                                <th>M√©todo</th>
                                <th>Monto</th>
                                <th>Aprobado</th>
                                <th>Configuraci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="approvedTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="approvedNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay pagos aprobados</p>
                </div>
            </div>
        </div>

        <!-- USUARIOS -->
        <div id="usersContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        Usuarios Registrados
                    </h2>
                    <button class="refresh-btn" onclick="loadUsers()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <!-- BUSCADOR DE USUARIOS -->
                <div class="search-container" style="margin-bottom: 20px;">
                    <input type="text" id="searchUserInput" class="search-input" placeholder="Buscar por ID, nombre o usuario...">
                    <button class="search-button" onclick="searchUsers()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
                
                <div class="loading" id="usersLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando usuarios...</p>
                </div>
                
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Usuario</th>
                                <th>Plan</th>
                                <th>VIP</th>
                                <th>Referidor</th>
                                <th>Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="usersNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay usuarios registrados</p>
                </div>
                
                <!-- PAGINACI√ìN -->
                <div class="pagination" id="usersPagination" style="display: none;">
                    <button class="page-btn" onclick="changeUsersPage(-1)" id="usersPrevBtn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span style="margin: 0 15px; color: var(--text-secondary);">
                        P√°gina <span id="usersCurrentPage">1</span> de <span id="usersTotalPages">1</span>
                    </span>
                    <button class="page-btn" onclick="changeUsersPage(1)" id="usersNextBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- SISTEMA DE REFERIDOS - MEJORADO -->
        <div id="referralsContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        Sistema de Referidos
                    </h2>
                    <button class="refresh-btn" onclick="loadReferrals()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>

                <div class="info-box referral">
                    <i class="fas fa-info-circle"></i>
                    <strong>Descuentos por referidos:</strong><br>
                    ‚Ä¢ Nivel 1 (referido directo): 20% de descuento por cada referido que pague.<br>
                    ‚Ä¢ Nivel 2 (referido del referido): 10% de descuento por cada referido que pague.<br>
                    Solo se aplica descuento si el referido ha pagado su plan. Los referidos que no pagan solo cuentan como n√∫mero, no como descuento.
                </div>
                
                <!-- BUSCADOR DE USUARIOS -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-search"></i>
                            Buscar Usuario
                        </h3>
                    </div>
                    
                    <div class="search-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label class="form-label">Buscar por ID, Nombre o Usuario</label>
                                <input type="text" id="searchUserReferrals" class="form-select" placeholder="Ej: 123456, @usuario, Juan">
                            </div>
                            <div>
                                <label class="form-label">Tipo de B√∫squeda</label>
                                <select id="searchType" class="form-select">
                                    <option value="all">Todos los usuarios</option>
                                    <option value="with_referrals">Usuarios con referidos</option>
                                    <option value="without_referrals">Usuarios sin referidos</option>
                                    <option value="referrers">Top referidores</option>
                                </select>
                            </div>
                        </div>
                        <button class="refresh-btn" onclick="searchUserReferrals()" style="width: 100%;">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </div>
                
                <!-- RESULTADOS DE B√öSQUEDA -->
                <div id="searchResults" style="display: none;">
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-user-circle"></i>
                                Informaci√≥n del Usuario
                            </h3>
                            <button class="refresh-btn" onclick="clearSearch()">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                        
                        <div class="loading" id="userDetailsLoading">
                            <div class="loading-spinner"></div>
                            <p>Cargando informaci√≥n del usuario...</p>
                        </div>
                        
                        <div id="userDetailsContent" style="display: none;">
                            <div class="user-info-header">
                                <div style="font-size: 2.5rem; color: #a78bfa;">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div>
                                    <h3 id="userName" style="margin-bottom: 5px; font-size: 1.5rem;"></h3>
                                    <div id="userDetails" style="color: var(--text-secondary);"></div>
                                </div>
                            </div>
                            
                            <div class="referral-stats-grid">
                                <div class="stat-mini">
                                    <div class="stat-mini-value" id="userTotalReferrals">0</div>
                                    <div class="stat-mini-label">Referidos Totales</div>
                                </div>
                                <div class="stat-mini">
                                    <div class="stat-mini-value" id="userPaidReferrals">0</div>
                                    <div class="stat-mini-label">Referidos Pagados</div>
                                </div>
                                <div class="stat-mini">
                                    <div class="stat-mini-value" id="userLevel1Referrals">0</div>
                                    <div class="stat-mini-label">Nivel 1</div>
                                </div>
                                <div class="stat-mini">
                                    <div class="stat-mini-value" id="userLevel2Referrals">0</div>
                                    <div class="stat-mini-label">Nivel 2</div>
                                </div>
                                <div class="stat-mini">
                                    <div class="stat-mini-value" id="userDiscount">0%</div>
                                    <div class="stat-mini-label">Descuento</div>
                                </div>
                            </div>
                            
                            <h4 style="margin: 20px 0 10px 0; color: var(--text);">
                                <i class="fas fa-list"></i> Lista de Referidos
                            </h4>
                            
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Nivel</th>
                                            <th>Plan</th>
                                            <th>Estado Pago</th>
                                            <th>Descuento</th>
                                            <th>Fecha</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userReferralsTableBody">
                                        <!-- Datos se cargar√°n aqu√≠ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="userNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 20px;"></i>
                            <p>Usuario no encontrado o sin referidos</p>
                        </div>
                    </div>
                </div>
                
                <!-- RESUMEN GENERAL -->
                <div class="referrals-container">
                    <div class="referral-card">
                        <div class="referral-header">
                            <i class="fas fa-chart-pie" style="color: #a78bfa;"></i>
                            <div class="referral-title">Resumen General</div>
                        </div>
                        
                        <div class="referral-stats">
                            <div class="referral-stat">
                                <div class="referral-stat-value" id="totalReferralsCount">0</div>
                                <div class="referral-stat-label">Referidos Totales</div>
                            </div>
                            <div class="referral-stat">
                                <div class="referral-stat-value" id="paidReferrals">0</div>
                                <div class="referral-stat-label">Referidos Pagados</div>
                            </div>
                            <div class="referral-stat">
                                <div class="referral-stat-value" id="level1Referrals">0</div>
                                <div class="referral-stat-label">Nivel 1</div>
                            </div>
                            <div class="referral-stat">
                                <div class="referral-stat-value" id="level2Referrals">0</div>
                                <div class="referral-stat-label">Nivel 2</div>
                            </div>
                        </div>
                        
                        <div class="referral-discount">
                            <div class="discount-title">Descuentos Aplicables Totales</div>
                            <div class="discount-item">
                                <span class="discount-level">Nivel 1 (20% c/u):</span>
                                <span class="discount-percent" id="level1Discount">0%</span>
                            </div>
                            <div class="discount-item">
                                <span class="discount-level">Nivel 2 (10% c/u):</span>
                                <span class="discount-percent" id="level2Discount">0%</span>
                            </div>
                            <div class="discount-item" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(139, 92, 246, 0.2);">
                                <span class="discount-level" style="font-weight: bold;">Descuento Total:</span>
                                <span class="discount-percent" style="font-weight: bold; color: #34d399;" id="totalDiscount">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="referral-card">
                        <div class="referral-header">
                            <i class="fas fa-trophy" style="color: #a78bfa;"></i>
                            <div class="referral-title">Top 10 Referidores</div>
                        </div>
                        
                        <div class="loading" id="topReferrersLoading">
                            <div class="loading-spinner"></div>
                            <p>Cargando top referidores...</p>
                        </div>
                        
                        <div class="table-container">
                            <table id="topReferrersTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Usuario</th>
                                        <th>Referidos</th>
                                        <th>Pagados</th>
                                        <th>Descuento</th>
                                        <th>Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="topReferrersTableBody">
                                    <!-- Datos se cargar√°n aqu√≠ -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="no-data" id="topReferrersNoData" style="display: none; text-align: center; padding: 20px; color: var(--text-secondary);">
                            <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>No hay datos de referidores</p>
                        </div>
                    </div>
                </div>
                
                <!-- LISTA COMPLETA DE REFERIDOS -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list-alt"></i>
                            Lista Completa de Referidos
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="filterReferrals" class="form-select" placeholder="Filtrar referidos..." style="width: 200px;">
                            <button class="refresh-btn" onclick="filterReferralsList()">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                        </div>
                    </div>
                    
                    <div class="loading" id="referralsListLoading">
                        <div class="loading-spinner"></div>
                        <p>Cargando lista de referidos...</p>
                    </div>
                    
                    <div class="table-container">
                        <table id="referralsListTable">
                            <thead>
                                <tr>
                                    <th>ID Referido</th>
                                    <th>Usuario</th>
                                    <th>Referidor</th>
                                    <th>Nivel</th>
                                    <th>Plan</th>
                                    <th>Estado Pago</th>
                                    <th>Descuento</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="referralsListTableBody">
                                <!-- Datos se cargar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="no-data" id="referralsListNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p>No hay referidos registrados</p>
                    </div>
                    
                    <!-- PAGINACI√ìN -->
                    <div id="referralsPagination" style="display: none; margin-top: 20px; text-align: center;">
                        <button class="action-btn" onclick="changeReferralsPage(-1)" id="prevPageBtn">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span style="margin: 0 15px; color: var(--text-secondary);">
                            P√°gina <span id="currentPage">1</span> de <span id="totalPages">1</span>
                        </span>
                        <button class="action-btn" onclick="changeReferralsPage(1)" id="nextPageBtn">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ARCHIVOS DE PLANES CON ARCHIVOS DE PRUEBA -->
        <div id="plan-filesContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-file-upload"></i>
                        Gesti√≥n de Archivos de Planes y Pruebas
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="refresh-btn" onclick="loadPlanFiles()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                        <button class="refresh-btn" onclick="showFilesStatsModal()" style="background: rgba(139, 92, 246, 0.2);">
                            <i class="fas fa-chart-bar"></i> Estad√≠sticas
                        </button>
                    </div>
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    Sube aqu√≠ los archivos de configuraci√≥n para cada plan. Cuando un usuario pague (manualmente o por USDT), el admin debe aprobar el pago y luego enviar manualmente el archivo correspondiente desde la pesta√±a "Pagos Aprobados".
                </div>
                
                <!-- ARCHIVOS DE PRUEBA -->
                <div class="trial-file-card">
                    <div class="trial-file-header">
                        <div class="trial-file-title">
                            <i class="fas fa-gift" style="color: var(--trial-light);"></i>
                            Archivos de Prueba Gratuita
                        </div>
                        <span class="badge trial-file">PRUEBA</span>
                    </div>
                    
                    <div class="info-box trial-files">
                        <i class="fas fa-info-circle"></i>
                        Estos archivos se env√≠an autom√°ticamente a usuarios que solicitan una prueba gratuita. Solo se puede enviar una vez por usuario.
                    </div>
                    
                    <div class="plan-file-info">
                        <div class="plan-file-row">
                            <span class="plan-file-label">Archivo actual:</span>
                            <span class="plan-file-value" id="trialPlanFile">No subido</span>
                        </div>
                        <div class="plan-file-row">
                            <span class="plan-file-label">√öltima actualizaci√≥n:</span>
                            <span class="plan-file-value" id="trialPlanDate">N/A</span>
                        </div>
                        <div class="plan-file-row">
                            <span class="plan-file-label">Usuarios que recibieron:</span>
                            <span class="plan-file-value" id="trialUsersCount">0</span>
                        </div>
                        <div class="plan-file-row">
                            <span class="plan-file-label">Nombre del archivo:</span>
                            <span class="plan-file-value filename-display" id="trialFileName">Ninguno</span>
                        </div>
                    </div>
                    
                    <div class="file-upload-area" onclick="openTrialFileUpload()" id="trialUploadArea">
                        <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                        <div class="file-upload-text">Subir archivo de prueba</div>
                        <div class="file-upload-subtext">Archivo .conf, .zip o .rar - Se env√≠a autom√°ticamente</div>
                    </div>
                    
                    <input type="file" id="trialPlanFileInput" accept=".conf,.zip,.rar" hidden>
                </div>
                
                <!-- PLANES DE PAGO -->
                <div class="plan-files-grid">
                    <!-- PLAN B√ÅSICO -->
                    <div class="plan-file-card">
                        <div class="plan-file-header">
                            <div class="plan-file-title">Plan B√°sico</div>
                            <span class="plan-file-badge">1 mes</span>
                        </div>
                        
                        <div class="plan-file-info">
                            <div class="plan-file-row">
                                <span class="plan-file-label">Precio:</span>
                                <span class="plan-file-value">800 CUP / 1.6 USDT</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Archivo actual:</span>
                                <span class="plan-file-value" id="basicPlanFile">No subido</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">√öltima actualizaci√≥n:</span>
                                <span class="plan-file-value" id="basicPlanDate">N/A</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Nombre del archivo:</span>
                                <span class="plan-file-value filename-display" id="basicFileName">Ninguno</span>
                            </div>
                        </div>
                        
                        <div class="file-upload-area" onclick="openPlanFileUpload('basico')" id="basicUploadArea">
                            <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                            <div class="file-upload-text">Subir archivo para B√°sico</div>
                            <div class="file-upload-subtext">Archivo .conf, .zip o .rar</div>
                        </div>
                        
                        <input type="file" id="basicPlanFileInput" accept=".conf,.zip,.rar" hidden>
                    </div>
                    
                    <!-- PLAN AVANZADO -->
                    <div class="plan-file-card">
                        <div class="plan-file-header">
                            <div class="plan-file-title">Plan Avanzado</div>
                            <span class="plan-file-badge">2 meses</span>
                        </div>
                        
                        <div class="plan-file-info">
                            <div class="plan-file-row">
                                <span class="plan-file-label">Precio:</span>
                                <span class="plan-file-value">1,300 CUP / 2.7 USDT</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Archivo actual:</span>
                                <span class="plan-file-value" id="advancedPlanFile">No subido</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">√öltima actualizaci√≥n:</span>
                                <span class="plan-file-value" id="advancedPlanDate">N/A</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Nombre del archivo:</span>
                                <span class="plan-file-value filename-display" id="advancedFileName">Ninguno</span>
                            </div>
                        </div>
                        
                        <div class="file-upload-area" onclick="openPlanFileUpload('avanzado')" id="advancedUploadArea">
                            <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                            <div class="file-upload-text">Subir archivo para Avanzado</div>
                            <div class="file-upload-subtext">Archivo .conf, .zip o .rar</div>
                        </div>
                        
                        <input type="file" id="advancedPlanFileInput" accept=".conf,.zip,.rar" hidden>
                    </div>
                    
                    <!-- PLAN PREMIUM -->
                    <div class="plan-file-card">
                        <div class="plan-file-header">
                            <div class="plan-file-title">Plan Premium</div>
                            <span class="plan-file-badge">1 mes</span>
                        </div>
                        
                        <div class="plan-file-info">
                            <div class="plan-file-row">
                                <span class="plan-file-label">Precio:</span>
                                <span class="plan-file-value">1,200 CUP / 2.5 USDT</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Archivo actual:</span>
                                <span class="plan-file-value" id="premiumPlanFile">No subido</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">√öltima actualizaci√≥n:</span>
                                <span class="plan-file-value" id="premiumPlanDate">N/A</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Nombre del archivo:</span>
                                <span class="plan-file-value filename-display" id="premiumFileName">Ninguno</span>
                            </div>
                        </div>
                        
                        <div class="file-upload-area" onclick="openPlanFileUpload('premium')" id="premiumUploadArea">
                            <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                            <div class="file-upload-text">Subir archivo para Premium</div>
                            <div class="file-upload-subtext">Archivo .conf, .zip o .rar</div>
                        </div>
                        
                        <input type="file" id="premiumPlanFileInput" accept=".conf,.zip,.rar" hidden>
                    </div>
                    
                    <!-- PLAN ANUAL -->
                    <div class="plan-file-card">
                        <div class="plan-file-header">
                            <div class="plan-file-title">Plan Anual</div>
                            <span class="plan-file-badge anual">12 meses</span>
                        </div>
                        
                        <div class="plan-file-info">
                            <div class="plan-file-row">
                                <span class="plan-file-label">Precio:</span>
                                <span class="plan-file-value">15,000 CUP / 30 USDT</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Archivo actual:</span>
                                <span class="plan-file-value" id="annualPlanFile">No subido</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">√öltima actualizaci√≥n:</span>
                                <span class="plan-file-value" id="annualPlanDate">N/A</span>
                            </div>
                            <div class="plan-file-row">
                                <span class="plan-file-label">Nombre del archivo:</span>
                                <span class="plan-file-value filename-display" id="annualFileName">Ninguno</span>
                            </div>
                        </div>
                        
                        <div class="file-upload-area" onclick="openPlanFileUpload('anual')" id="annualUploadArea">
                            <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                            <div class="file-upload-text">Subir archivo para Anual</div>
                            <div class="file-upload-subtext">Archivo .conf, .zip o .rar</div>
                        </div>
                        
                        <input type="file" id="annualPlanFileInput" accept=".conf,.zip,.rar" hidden>
                    </div>
                </div>
                
                <div class="info-box usdt" style="margin-top: 20px;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Para pagos USDT:</strong><br>
                    ‚Ä¢ El usuario debe enviar captura de pantalla mostrando la wallet destino y los datos de la transacci√≥n<br>
                    ‚Ä¢ El admin aprueba manualmente el pago despu√©s de verificar la captura<br>
                    ‚Ä¢ Luego el admin env√≠a manualmente el archivo desde la pesta√±a "Pagos Aprobados"<br>
                    ‚Ä¢ # Sistema de detecci√≥n autom√°tica de pagos USDT desactivado
                </div>
            </div>
        </div>

        <!-- JUEGOS/SERVIDORES -->
        <div id="gamesContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-gamepad"></i>
                        Juegos/Servidores Solicitados
                    </h2>
                    <button class="refresh-btn" onclick="loadGamesStats()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <div class="loading" id="gamesLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando estad√≠sticas de juegos...</p>
                </div>
                
                <div class="table-container">
                    <table id="gamesTable">
                        <thead>
                            <tr>
                                <th>üéÆ Juego/Servidor</th>
                                <th>Solicitudes</th>
                                <th>üì° Tipo de Conexi√≥n</th>
                                <th>√öltima Solicitud</th>
                            </tr>
                        </thead>
                        <tbody id="gamesTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="gamesNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-gamepad" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay datos de juegos/servidores</p>
                </div>
            </div>
        </div>

        <!-- BROADCAST -->
        <div id="broadcastContent" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-bullhorn"></i>
                        Enviar Mensaje Masivo (Broadcast)
                    </h2>
                </div>

                <div class="info-box broadcast">
                    <i class="fas fa-info-circle"></i>
                    Env√≠a un mensaje a m√∫ltiples usuarios simult√°neamente. Los mensajes se enviar√°n en segundo plano y podr√°s monitorear el progreso.
                </div>
                
                <div class="broadcast-form">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-users"></i> Destinatarios:
                        </label>
                        <select id="broadcastTarget" class="form-select">
                            <option value="all">üë• Todos los usuarios</option>
                            <option value="vip">üëë Solo usuarios VIP</option>
                            <option value="non_vip">üë§ Usuarios no VIP</option>
                            <option value="trial_pending">‚è≥ Usuarios con prueba pendiente</option>
                            <option value="trial_received">‚úÖ Usuarios que recibieron prueba</option>
                            <option value="active">üì± Usuarios activos (√∫ltimos 30 d√≠as)</option>
                            <option value="with_referrals">ü§ù Usuarios con referidos</option>
                            <option value="usdt_payers">üí∞ Usuarios que pagaron con USDT</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-comment-alt"></i> Mensaje:
                        </label>
                        <textarea id="broadcastMessage" class="form-textarea" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                    </div>
                    
                    <button class="submit-broadcast" onclick="sendBroadcast()" id="broadcastButton">
                        <i class="fas fa-paper-plane"></i>
                        Enviar Broadcast
                    </button>
                </div>
            </div>
            
            <!-- HISTORIAL DE BROADCASTS -->
            <div class="card" style="margin-top: 25px;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-history"></i>
                        Historial de Broadcasts
                    </h2>
                    <button class="refresh-btn" onclick="loadBroadcasts()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
                
                <div class="loading" id="broadcastLoading">
                    <div class="loading-spinner"></div>
                    <p>Cargando historial de broadcasts...</p>
                </div>
                
                <div class="table-container">
                    <table id="broadcastTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Mensaje</th>
                                <th>Destinatarios</th>
                                <th>Enviados</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="broadcastTableBody">
                            <!-- Datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="no-data" id="broadcastNoData" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-bullhorn" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>No hay broadcasts en el historial</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA VER CAPTURA -->
    <div id="screenshotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Captura de Pantalla del Pago</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <img id="screenshotImage" class="screenshot-preview" src="" alt="Captura de pantalla">
            <div class="payment-info">
                <p><strong>Usuario:</strong> <span id="modalUserId"></span></p>
                <p><strong>Plan:</strong> <span id="modalPlan"></span></p>
                <p><strong>Monto:</strong> <span id="modalAmount"></span> <span id="modalCurrency"></span></p>
                <p><strong>Fecha:</strong> <span id="modalDate"></span></p>
                <p><strong>M√©todo:</strong> <span id="modalMethod"></span></p>
            </div>
            <div class="action-buttons">
                <button class="action-btn approve" onclick="approvePayment(currentPaymentId)">
                    <i class="fas fa-check"></i>
                    Aprobar Pago
                </button>
                <button class="action-btn reject" onclick="rejectPayment(currentPaymentId)">
                    <i class="fas fa-times"></i>
                    Rechazar Pago
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA ENVIAR CONFIGURACI√ìN -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Enviar Configuraci√≥n Manualmente</h3>
                <button class="close-modal" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="config-form">
                <p><strong>Usuario:</strong> <span id="configUserId"></span></p>
                <p><strong>Plan:</strong> <span id="configPlan"></span></p>
                <p><strong>Pago ID:</strong> <span id="configPaymentId"></span></p>
                
                <div style="margin-bottom: 15px;">
                    <p style="color: #a5b4fc; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i>
                        # Sistema de env√≠o autom√°tico desactivado<br>
                        Sube el archivo y env√≠alo manualmente al usuario
                    </p>
                </div>
                
                <input type="file" id="configFile" class="file-input" accept=".conf,.zip,.rar">
                
                <button class="submit-config" onclick="sendConfigFile()">
                    <i class="fas fa-paper-plane"></i>
                    Enviar Configuraci√≥n Manualmente
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA DETALLES DE USUARIO -->
    <div id="userDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-circle"></i>
                    Detalles del Usuario
                </h3>
                <button class="close-modal" onclick="closeUserDetailsModal()">&times;</button>
            </div>
            
            <div class="loading" id="userDetailsModalLoading">
                <div class="loading-spinner"></div>
                <p>Cargando detalles del usuario...</p>
            </div>
            
            <div id="userDetailsModalContent" style="display: none;">
                <div class="user-details-grid">
                    <div class="user-detail-card">
                        <div class="user-detail-label">ID de Usuario</div>
                        <div class="user-detail-value" id="modalUserIdDetail"></div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-label">Nombre</div>
                        <div class="user-detail-value" id="modalUserName"></div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-label">Usuario</div>
                        <div class="user-detail-value" id="modalUserUsername"></div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-label">Plan Actual</div>
                        <div class="user-detail-value" id="modalUserPlan"></div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-label">Estado VIP</div>
                        <div class="user-detail-value" id="modalUserVip"></div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-label">Referidor</div>
                        <div class="user-detail-value" id="modalUserReferrer"></div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-label">Referidos Directos</div>
                        <div class="user-detail-value" id="modalUserReferrals"></div>
                    </div>
                    <div class="user-detail-card">
                        <div class="user-detail-label">Fecha de Registro</div>
                        <div class="user-detail-value" id="modalUserJoinDate"></div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 25px; display: flex; gap: 10px;">
                    <button class="action-btn remove-vip" onclick="removeVipFromUser(currentUserDetailsId)" id="removeVipBtn">
                        <i class="fas fa-crown"></i>
                        Quitar VIP
                    </button>
                    <button class="action-btn view-details" onclick="searchUserById(currentUserDetailsId, true)">
                        <i class="fas fa-users"></i>
                        Ver Referidos
                    </button>
                    <button class="action-btn message" onclick="messageUser(currentUserDetailsId)">
                        <i class="fas fa-envelope"></i>
                        Enviar Mensaje
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PARA ESTAD√çSTICAS DE ARCHIVOS -->
    <div id="filesStatsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-chart-bar"></i>
                    Estad√≠sticas Detalladas de Archivos
                </h3>
                <button class="close-modal" onclick="closeFilesStatsModal()">&times;</button>
            </div>
            
            <div class="loading" id="filesStatsLoading">
                <div class="loading-spinner"></div>
                <p>Cargando estad√≠sticas...</p>
            </div>
            
            <div id="filesStatsContent" style="display: none;">
                <!-- RESUMEN GENERAL -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-tachometer-alt"></i>
                            Resumen General
                        </h4>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card file-stats">
                            <i class="fas fa-file-upload stat-icon"></i>
                            <div class="stat-value" id="totalFilesUploaded">0</div>
                            <div class="stat-label">Archivos Subidos</div>
                        </div>
                        
                        <div class="stat-card file-stats">
                            <i class="fas fa-paper-plane stat-icon"></i>
                            <div class="stat-value" id="totalFilesSent">0</div>
                            <div class="stat-label">Archivos Enviados</div>
                        </div>
                        
                        <div class="stat-card file-stats">
                            <i class="fas fa-box-open stat-icon"></i>
                            <div class="stat-value" id="totalAvailableFiles">0</div>
                            <div class="stat-label">Archivos Disponibles</div>
                        </div>
                        
                        <div class="stat-card file-stats">
                            <i class="fas fa-users stat-icon"></i>
                            <div class="stat-value" id="totalUsersWithFiles">0</div>
                            <div class="stat-label">Usuarios Con Archivos</div>
                        </div>
                    </div>
                </div>
                
                <!-- DETALLES POR PLAN -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-list-alt"></i>
                            Detalles por Plan
                        </h4>
                    </div>
                    
                    <div class="table-container">
                        <table id="filesStatsTable">
                            <thead>
                                <tr>
                                    <th>Plan</th>
                                    <th>Archivo</th>
                                    <th>Subido</th>
                                    <th>Env√≠os</th>
                                    <th>Disponibles</th>
                                    <th>√öltimo Env√≠o</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="filesStatsTableBody">
                                <!-- Datos se cargar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="no-data" id="filesStatsNoData" style="display: none; text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-file-alt" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>No hay estad√≠sticas disponibles</p>
                    </div>
                </div>
                
                <!-- HISTORIAL DE ENV√çOS RECIENTES -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-history"></i>
                            Historial de Env√≠os Recientes
                        </h4>
                        <button class="refresh-btn" onclick="loadFilesStats()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table id="filesHistoryTable">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Plan</th>
                                    <th>Archivo</th>
                                    <th>Fecha Env√≠o</th>
                                    <th>M√©todo</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="filesHistoryTableBody">
                                <!-- Datos se cargar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="no-data" id="filesHistoryNoData" style="display: none; text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-history" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>No hay historial de env√≠os</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICACI√ìN -->
    <div id="notification" class="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationText">Mensaje</span>
    </div>

    <script>
        // Variables globales
        let currentPaymentId = null;
        let currentPaymentMethod = null;
        let currentTab = 'stats';
        let currentUserId = null;
        let currentTrialUserId = null;
        let isAdminUser = false;
        let currentPlanForUpload = null;
        let allReferrals = [];
        let currentReferralsPage = 1;
        const referralsPerPage = 20;
        let filteredReferrals = [];
        let allUsers = [];
        let currentUsersPage = 1;
        const usersPerPage = 20;
        let filteredUsers = [];
        let currentUserDetailsId = null;

        // Inicializar Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();

        // Obtener par√°metros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        const admin = urlParams.get('admin') === 'true';

        // Verificar permisos de administrador
        async function checkAdminAccess() {
            console.log('üîç Verificando acceso de administrador...');
            
            if (!admin) {
                console.log('‚ùå Par√°metro admin=false o no presente');
                showNotification('‚ùå No tienes permisos de administrador', 'error');
                setTimeout(() => {
                    window.location.href = '/plans.html?userId=' + userId;
                }, 2000);
                return;
            }

            try {
                console.log(`üë§ Verificando admin para ${userId}`);
                const response = await fetch(`/api/check-admin/${userId}`);
                const data = await response.json();
                
                if (!data.isAdmin) {
                    console.log('‚ùå Usuario no es administrador');
                    showNotification('‚ùå No eres administrador', 'error');
                    setTimeout(() => {
                        window.location.href = '/plans.html?userId=' + userId;
                    }, 2000);
                    return;
                }

                isAdminUser = true;
                currentUserId = userId;
                console.log('‚úÖ Usuario es administrador');
                loadStats();
                loadPlanFiles();
            } catch (error) {
                console.error('‚ùå Error verificando admin:', error);
                showNotification('‚ùå Error verificando permisos', 'error');
            }
        }

        // Cargar estad√≠sticas generales
        async function loadStats() {
            try {
                console.log('üìä Cargando estad√≠sticas...');
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('totalUsers').textContent = stats.users?.total || 0;
                document.getElementById('vipUsers').textContent = stats.users?.vip || 0;
                document.getElementById('trialRequests').textContent = stats.users?.trial_requests || 0;
                document.getElementById('pendingPaymentsCount').textContent = stats.payments?.pending || 0;
                document.getElementById('totalRevenue').textContent = stats.revenue?.total || 0;
                document.getElementById('trialPendingCount').textContent = stats.users?.trial_pending || 0;
                document.getElementById('totalReferrals').textContent = stats.referrals?.total || 0;
                document.getElementById('usdtPayments').textContent = stats.payments?.usdt || 0;
                document.getElementById('broadcastCount').textContent = stats.broadcasts?.total || 0;
                
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas:', error);
            }
        }

        // Cargar pagos pendientes - MODIFICADO PARA USDT CON CAPTURA
        async function loadPendingPayments() {
            try {
                document.getElementById('pendingLoading').style.display = 'block';
                document.getElementById('pendingTable').style.display = 'none';
                document.getElementById('pendingNoData').style.display = 'none';
                
                console.log('üîç Cargando pagos pendientes...');
                const response = await fetch('/api/payments/pending');
                const payments = await response.json();
                
                document.getElementById('pendingLoading').style.display = 'none';
                
                if (!payments || payments.length === 0) {
                    document.getElementById('pendingNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('pendingTableBody');
                tableBody.innerHTML = '';
                
                payments.forEach(payment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${payment.id || 'N/A'}</td>
                        <td>
                            <strong>${payment.user?.first_name || payment.user?.username || 'Usuario'}</strong><br>
                            <small>@${payment.user?.username || 'sin_usuario'}</small>
                        </td>
                        <td>${getPlanName(payment.plan)}</td>
                        <td>${getPaymentMethodBadge(payment.method)}</td>
                        <td>${payment.price || 0} ${payment.method === 'usdt' ? 'USDT' : 'CUP'}</td>
                        <td>${payment.created_at ? new Date(payment.created_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                        <td><span class="badge pending">Pendiente</span></td>
                        <td>
                            <button class="action-btn approve" onclick="viewScreenshot('${payment.id}', '${payment.telegram_id}', '${payment.plan}', '${payment.price}', '${payment.created_at}', '${payment.screenshot_url}', '${payment.method}')">
                                <i class="fas fa-eye"></i> Ver Captura
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('pendingTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando pagos pendientes:', error);
                document.getElementById('pendingLoading').style.display = 'none';
                showNotification('‚ùå Error cargando pagos pendientes', 'error');
            }
        }

        // Ver captura de pantalla - MODIFICADO PARA MOSTRAR M√âTODO
        function viewScreenshot(paymentId, telegramId, plan, amount, date, screenshotUrl, method) {
            currentPaymentId = paymentId;
            currentPaymentMethod = method;
            
            document.getElementById('screenshotImage').src = screenshotUrl;
            document.getElementById('modalUserId').textContent = telegramId;
            document.getElementById('modalPlan').textContent = getPlanName(plan);
            document.getElementById('modalAmount').textContent = amount;
            document.getElementById('modalCurrency').textContent = method === 'usdt' ? 'USDT' : 'CUP';
            document.getElementById('modalDate').textContent = new Date(date).toLocaleDateString('es-ES');
            document.getElementById('modalMethod').innerHTML = getPaymentMethodBadge(method);
            
            document.getElementById('screenshotModal').classList.add('active');
        }

        // Cargar pruebas pendientes
        async function loadPendingTrials() {
            try {
                document.getElementById('trialLoading').style.display = 'block';
                document.getElementById('trialTable').style.display = 'none';
                document.getElementById('trialNoData').style.display = 'none';
                
                console.log('üéØ Cargando pruebas pendientes...');
                const response = await fetch('/api/trials/pending');
                const trials = await response.json();
                
                document.getElementById('trialLoading').style.display = 'none';
                
                if (!trials || trials.length === 0) {
                    document.getElementById('trialNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('trialTableBody');
                tableBody.innerHTML = '';
                
                trials.forEach(trial => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${trial.telegram_id || 'N/A'}</td>
                        <td>
                            <strong>${trial.first_name || trial.username || 'Usuario'}</strong><br>
                            <small>@${trial.username || 'sin_usuario'}</small>
                        </td>
                        <td>${trial.trial_info?.game_server || 'No especificado'}</td>
                        <td>${trial.trial_info?.connection_type || 'No especificado'}</td>
                        <td>${trial.trial_requested_at ? new Date(trial.trial_requested_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                        <td>
                            <button class="action-btn send-trial" onclick="sendTrialConfig('${trial.telegram_id}', '${trial.first_name || trial.username || 'Usuario'}')">
                                <i class="fas fa-gift"></i> Enviar
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('trialTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando pruebas pendientes:', error);
                document.getElementById('trialLoading').style.display = 'none';
                showNotification('‚ùå Error cargando pruebas pendientes', 'error');
            }
        }

        // Cargar pagos aprobados
        async function loadApprovedPayments() {
            try {
                document.getElementById('approvedLoading').style.display = 'block';
                document.getElementById('approvedTable').style.display = 'none';
                document.getElementById('approvedNoData').style.display = 'none';
                
                console.log('üîç Cargando pagos aprobados...');
                const response = await fetch('/api/payments/approved');
                const payments = await response.json();
                
                document.getElementById('approvedLoading').style.display = 'none';
                
                if (!payments || payments.length === 0) {
                    document.getElementById('approvedNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('approvedTableBody');
                tableBody.innerHTML = '';
                
                payments.forEach(payment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${payment.id || 'N/A'}</td>
                        <td>
                            <strong>${payment.user?.first_name || payment.user?.username || 'Usuario'}</strong><br>
                            <small>@${payment.user?.username || 'sin_usuario'}</small>
                        </td>
                        <td>${getPlanName(payment.plan)}</td>
                        <td>${getPaymentMethodBadge(payment.method)}</td>
                        <td>${payment.price || 0} ${payment.method === 'usdt' ? 'USDT' : 'CUP'}</td>
                        <td>${payment.approved_at ? new Date(payment.approved_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                        <td>
                            ${payment.config_sent ? 
                                '<span class="badge approved">Enviada</span>' : 
                                '<span class="badge pending">Pendiente</span>'
                            }
                        </td>
                        <td>
                            ${!payment.config_sent ? 
                                `<button class="action-btn send-config" onclick="openConfigModal('${payment.id}', '${payment.telegram_id}', '${payment.plan}')">
                                    <i class="fas fa-paper-plane"></i> Enviar Manual
                                </button>` : 
                                '<span class="badge approved">Archivo enviado</span>'
                            }
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('approvedTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando pagos aprobados:', error);
                document.getElementById('approvedLoading').style.display = 'none';
                showNotification('‚ùå Error cargando pagos aprobados', 'error');
            }
        }

        // Cargar usuarios con paginaci√≥n - CORREGIDA
        async function loadUsers() {
            try {
                document.getElementById('usersLoading').style.display = 'block';
                document.getElementById('usersTable').style.display = 'none';
                document.getElementById('usersNoData').style.display = 'none';
                document.getElementById('usersPagination').style.display = 'none';
                
                console.log('üîç Cargando usuarios...');
                const response = await fetch('/api/all-users');
                const users = await response.json();
                
                document.getElementById('usersLoading').style.display = 'none';
                
                if (!users || users.length === 0) {
                    document.getElementById('usersNoData').style.display = 'block';
                    return;
                }
                
                // Normalizar datos: asegurar que todos los usuarios tengan campo vip
                const normalizedUsers = users.map(user => ({
                    ...user,
                    vip: user.vip || false // Asegurar que siempre haya un valor booleano
                }));
                
                // Guardar todos los usuarios
                allUsers = normalizedUsers;
                filteredUsers = [...allUsers];
                
                // Mostrar primera p√°gina
                displayUsersPage(1);
                
            } catch (error) {
                console.error('‚ùå Error cargando usuarios:', error);
                document.getElementById('usersLoading').style.display = 'none';
                showNotification('‚ùå Error cargando usuarios', 'error');
            }
        }

        // Mostrar p√°gina de usuarios - MODIFICADA CON BOT√ìN QUITAR VIP
        function displayUsersPage(page) {
            currentUsersPage = page;
            
            const startIndex = (page - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const pageUsers = filteredUsers.slice(startIndex, endIndex);
            
            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = '';
            
            if (pageUsers.length === 0) {
                document.getElementById('usersNoData').style.display = 'block';
                document.getElementById('usersPagination').style.display = 'none';
                return;
            }
            
            document.getElementById('usersNoData').style.display = 'none';
            document.getElementById('usersTable').style.display = 'table';
            
            pageUsers.forEach(user => {
                const row = document.createElement('tr');
                const isVip = user.vip || false; // CORREGIDO: usar user.vip en lugar de user.is_vip
                const vipBadge = isVip ? 
                    '<span class="badge vip">VIP</span>' : 
                    '<span class="badge non-vip">No VIP</span>';
                
                // Obtener informaci√≥n de referidor
                let referrerInfo = 'Directo';
                if (user.referrer_id) {
                    referrerInfo = user.referrer_username ? 
                        `@${user.referrer_username}` : 
                        `ID: ${user.referrer_id}`;
                }
                
                row.innerHTML = `
                    <td>${user.telegram_id || 'N/A'}</td>
                    <td>${user.first_name || 'Usuario'}</td>
                    <td>${user.username ? '@' + user.username : 'sin_usuario'}</td>
                    <td>${user.current_plan ? getPlanName(user.current_plan) : 'Sin plan'}</td>
                    <td>${vipBadge}</td>
                    <td>${referrerInfo}</td>
                    <td>${user.created_at ? new Date(user.created_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                    <td>
                        <button class="action-btn view-details" onclick="viewUserDetailsModal('${user.telegram_id}')">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        ${isVip ? 
                            `<button class="action-btn remove-vip" onclick="removeVipFromUser('${user.telegram_id}')">
                                <i class="fas fa-crown"></i> Quitar VIP
                            </button>` : 
                            ''
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Actualizar paginaci√≥n
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            document.getElementById('usersCurrentPage').textContent = page;
            document.getElementById('usersTotalPages').textContent = totalPages;
            
            document.getElementById('usersPrevBtn').disabled = page <= 1;
            document.getElementById('usersNextBtn').disabled = page >= totalPages;
            
            document.getElementById('usersPagination').style.display = totalPages > 1 ? 'flex' : 'none';
        }

        // Cambiar p√°gina de usuarios
        function changeUsersPage(direction) {
            const newPage = currentUsersPage + direction;
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            
            if (newPage >= 1 && newPage <= totalPages) {
                displayUsersPage(newPage);
            }
        }

        // Buscar usuarios
        function searchUsers() {
            const searchTerm = document.getElementById('searchUserInput').value.toLowerCase();
            
            if (!searchTerm) {
                filteredUsers = [...allUsers];
            } else {
                filteredUsers = allUsers.filter(user => {
                    return (
                        (user.first_name && user.first_name.toLowerCase().includes(searchTerm)) ||
                        (user.username && user.username.toLowerCase().includes(searchTerm)) ||
                        (user.telegram_id && user.telegram_id.toString().includes(searchTerm)) ||
                        (user.current_plan && getPlanName(user.current_plan).toLowerCase().includes(searchTerm)) ||
                        (user.referrer_username && user.referrer_username.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            displayUsersPage(1);
        }

        // Ver detalles del usuario en modal
        async function viewUserDetailsModal(userId) {
            currentUserDetailsId = userId;
            
            document.getElementById('userDetailsModal').classList.add('active');
            document.getElementById('userDetailsModalLoading').style.display = 'block';
            document.getElementById('userDetailsModalContent').style.display = 'none';
            
            try {
                const response = await fetch(`/api/user/${userId}/details`);
                const user = await response.json();
                
                document.getElementById('userDetailsModalLoading').style.display = 'none';
                document.getElementById('userDetailsModalContent').style.display = 'block';
                
                // Actualizar datos del modal
                document.getElementById('modalUserIdDetail').textContent = user.telegram_id || 'N/A';
                document.getElementById('modalUserName').textContent = user.first_name || 'Usuario';
                document.getElementById('modalUserUsername').textContent = '@' + (user.username || 'sin_usuario');
                document.getElementById('modalUserPlan').textContent = getPlanName(user.current_plan) || 'Sin plan';
                document.getElementById('modalUserVip').innerHTML = user.vip ? 
                    '<span class="badge vip">VIP</span>' : 
                    '<span class="badge non-vip">No VIP</span>';
                document.getElementById('modalUserReferrer').textContent = user.referrer_id ? 
                    '@' + (user.referrer_username || user.referrer_id) : 'Directo';
                document.getElementById('modalUserReferrals').textContent = user.level1_referrals || 0;
                document.getElementById('modalUserJoinDate').textContent = user.created_at ? 
                    new Date(user.created_at).toLocaleDateString('es-ES') : 'N/A';
                
                // Mostrar/ocultar bot√≥n de quitar VIP
                const removeVipBtn = document.getElementById('removeVipBtn');
                if (user.vip) {
                    removeVipBtn.style.display = 'flex';
                } else {
                    removeVipBtn.style.display = 'none';
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando detalles del usuario:', error);
                document.getElementById('userDetailsModalLoading').style.display = 'none';
                showNotification('‚ùå Error cargando detalles del usuario', 'error');
            }
        }

        // Cerrar modal de detalles de usuario
        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.remove('active');
            currentUserDetailsId = null;
        }

        // Quitar VIP a un usuario - MEJORADA
        async function removeVipFromUser(userId) {
            if (!confirm('¬øEst√°s seguro de quitar el estatus VIP a este usuario?\n\nEl usuario perder√° acceso inmediato.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/user/${userId}/remove-vip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminId: currentUserId
                    })
                });
                
                if (response.ok) {
                    showNotification('‚úÖ VIP quitado correctamente', 'success');
                    // Recargar usuarios
                    loadUsers();
                    // Recargar estad√≠sticas
                    loadStats();
                    
                    // Si estamos en la pesta√±a de referidos, recargar tambi√©n
                    if (currentTab === 'referrals') {
                        loadReferrals();
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error quitando VIP');
                }
            } catch (error) {
                console.error('‚ùå Error quitando VIP:', error);
                showNotification('‚ùå Error quitando VIP: ' + error.message, 'error');
            }
        }

        // Enviar mensaje a un usuario
        async function messageUser(userId) {
            const message = prompt('Escribe el mensaje para el usuario:');
            if (!message) return;
            
            try {
                const response = await fetch(`/api/user/${userId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        adminId: currentUserId
                    })
                });
                
                if (response.ok) {
                    showNotification('‚úÖ Mensaje enviado', 'success');
                } else {
                    throw new Error('Error enviando mensaje');
                }
            } catch (error) {
                console.error('‚ùå Error enviando mensaje:', error);
                showNotification('‚ùå Error enviando mensaje', 'error');
            }
        }

        // Cargar sistema de referidos mejorado
        async function loadReferrals() {
            try {
                document.getElementById('referralsListLoading').style.display = 'block';
                document.getElementById('topReferrersLoading').style.display = 'block';
                
                console.log('ü§ù Cargando sistema de referidos mejorado...');
                
                // Cargar estad√≠sticas generales
                const statsResponse = await fetch('/api/referrals/stats');
                const stats = await statsResponse.json();
                
                // Actualizar tarjeta de resumen
                document.getElementById('totalReferralsCount').textContent = stats.total_referrals || 0;
                document.getElementById('paidReferrals').textContent = stats.paid_referrals || 0;
                document.getElementById('level1Referrals').textContent = stats.level1_referrals || 0;
                document.getElementById('level2Referrals').textContent = stats.level2_referrals || 0;
                
                // Calcular descuentos
                const level1Discount = (stats.paid_level1 || 0) * 20;
                const level2Discount = (stats.paid_level2 || 0) * 10;
                const totalDiscount = level1Discount + level2Discount;
                
                document.getElementById('level1Discount').textContent = level1Discount + '%';
                document.getElementById('level2Discount').textContent = level2Discount + '%';
                document.getElementById('totalDiscount').textContent = totalDiscount + '%';
                
                // Cargar top referidores
                const topResponse = await fetch('/api/referrals/top');
                const topReferrers = await topResponse.json();
                
                document.getElementById('topReferrersLoading').style.display = 'none';
                
                const topTableBody = document.getElementById('topReferrersTableBody');
                topTableBody.innerHTML = '';
                
                if (topReferrers && topReferrers.length > 0) {
                    document.getElementById('topReferrersNoData').style.display = 'none';
                    
                    topReferrers.forEach((referrer, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>
                                <strong>${referrer.first_name || 'Usuario'}</strong><br>
                                <small>@${referrer.username || 'sin_usuario'}</small><br>
                                <small style="color: #888;">ID: ${referrer.telegram_id}</small>
                            </td>
                            <td style="text-align: center;">${referrer.total_referrals || 0}</td>
                            <td style="text-align: center;">${referrer.paid_referrals || 0}</td>
                            <td style="text-align: center;">
                                <span class="badge" style="background: rgba(52, 211, 153, 0.2); color: #34d399;">
                                    ${(referrer.paid_referrals || 0) * 20}%
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <button class="action-btn view-details" onclick="searchUserById('${referrer.telegram_id}')">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                            </td>
                        `;
                        topTableBody.appendChild(row);
                    });
                } else {
                    document.getElementById('topReferrersNoData').style.display = 'block';
                }
                
                // Cargar lista completa de referidos
                const listResponse = await fetch('/api/referrals/list');
                const referralsList = await listResponse.json();
                
                document.getElementById('referralsListLoading').style.display = 'none';
                
                // Guardar datos globales
                allReferrals = referralsList || [];
                filteredReferrals = [...allReferrals];
                
                // Mostrar primera p√°gina
                displayReferralsPage(1);
                
            } catch (error) {
                console.error('‚ùå Error cargando sistema de referidos:', error);
                document.getElementById('referralsListLoading').style.display = 'none';
                document.getElementById('topReferrersLoading').style.display = 'none';
                showNotification('‚ùå Error cargando sistema de referidos', 'error');
            }
        }

        // Mostrar p√°gina de referidos
        function displayReferralsPage(page) {
            currentReferralsPage = page;
            
            const startIndex = (page - 1) * referralsPerPage;
            const endIndex = startIndex + referralsPerPage;
            const pageReferrals = filteredReferrals.slice(startIndex, endIndex);
            
            const listTableBody = document.getElementById('referralsListTableBody');
            listTableBody.innerHTML = '';
            
            if (pageReferrals.length === 0) {
                document.getElementById('referralsListNoData').style.display = 'block';
                document.getElementById('referralsPagination').style.display = 'none';
                return;
            }
            
            document.getElementById('referralsListNoData').style.display = 'none';
            
            pageReferrals.forEach(referral => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${referral.user_id || 'N/A'}</td>
                    <td>
                        <strong>${referral.user_name || 'Usuario'}</strong><br>
                        <small>ID: ${referral.user_id || 'N/A'}</small>
                    </td>
                    <td>
                        ${referral.referrer_name ? 
                            `<strong>${referral.referrer_name}</strong><br>
                             <small>ID: ${referral.referrer_id || 'N/A'}</small>` : 
                            'Directo'
                        }
                    </td>
                    <td>
                        ${referral.level === 1 ? 
                            '<span class="badge referral-level-1">Nivel 1</span>' : 
                            '<span class="badge referral-level-2">Nivel 2</span>'
                        }
                    </td>
                    <td>${getPlanName(referral.plan) || 'Sin plan'}</td>
                    <td>
                        ${referral.has_paid ? 
                            '<span class="badge paid">Pagado</span>' : 
                            '<span class="badge unpaid">No pagado</span>'
                        }
                    </td>
                    <td>
                        ${referral.has_paid ? 
                            (referral.level === 1 ? '20%' : '10%') : 
                            '0%'
                        }
                    </td>
                    <td>${referral.referred_at ? new Date(referral.referred_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                    <td>
                        <button class="action-btn view-details" onclick="searchUserById('${referral.user_id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${referral.referrer_id ? 
                            `<button class="action-btn view-details" onclick="searchUserById('${referral.referrer_id}')" title="Ver referidor">
                                <i class="fas fa-user-friends"></i>
                            </button>` : 
                            ''
                        }
                    </td>
                `;
                listTableBody.appendChild(row);
            });
            
            // Actualizar paginaci√≥n
            const totalPages = Math.ceil(filteredReferrals.length / referralsPerPage);
            document.getElementById('currentPage').textContent = page;
            document.getElementById('totalPages').textContent = totalPages;
            
            document.getElementById('prevPageBtn').disabled = page <= 1;
            document.getElementById('nextPageBtn').disabled = page >= totalPages;
            
            document.getElementById('referralsPagination').style.display = totalPages > 1 ? 'block' : 'none';
        }

        // Cambiar p√°gina de referidos
        function changeReferralsPage(direction) {
            const newPage = currentReferralsPage + direction;
            const totalPages = Math.ceil(filteredReferrals.length / referralsPerPage);
            
            if (newPage >= 1 && newPage <= totalPages) {
                displayReferralsPage(newPage);
            }
        }

        // Filtrar lista de referidos
        function filterReferralsList() {
            const filterText = document.getElementById('filterReferrals').value.toLowerCase();
            
            if (!filterText) {
                filteredReferrals = [...allReferrals];
            } else {
                filteredReferrals = allReferrals.filter(referral => {
                    return (
                        (referral.user_name && referral.user_name.toLowerCase().includes(filterText)) ||
                        (referral.user_id && referral.user_id.toString().includes(filterText)) ||
                        (referral.referrer_name && referral.referrer_name.toLowerCase().includes(filterText)) ||
                        (referral.referrer_id && referral.referrer_id.toString().includes(filterText)) ||
                        (getPlanName(referral.plan) && getPlanName(referral.plan).toLowerCase().includes(filterText))
                    );
                });
            }
            
            displayReferralsPage(1);
        }

        // Buscar referidos de un usuario espec√≠fico - CORREGIDA
        async function searchUserReferrals() {
            const searchTerm = document.getElementById('searchUserReferrals').value.trim();
            const searchType = document.getElementById('searchType').value;
            
            if (!searchTerm && searchType === 'all') {
                showNotification('‚ö†Ô∏è Ingresa un t√©rmino de b√∫squeda', 'warning');
                return;
            }
            
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('userDetailsLoading').style.display = 'block';
            document.getElementById('userDetailsContent').style.display = 'none';
            document.getElementById('userNoData').style.display = 'none';
            
            try {
                let response;
                let data;
                
                if (searchType === 'all' && searchTerm) {
                    // Buscar usuario espec√≠fico
                    console.log(`üîç Buscando usuario: ${searchTerm}`);
                    response = await fetch(`/api/user-info/${searchTerm}`);
                    
                    if (!response.ok) {
                        throw new Error('Usuario no encontrado');
                    }
                    
                    const userData = await response.json();
                    console.log('üìä Datos de usuario encontrados:', userData);
                    
                    // Obtener referidos de este usuario
                    const referralsResponse = await fetch(`/api/referrals/user/${searchTerm}`);
                    const referralsData = referralsResponse.ok ? await referralsResponse.json() : { referrals: [] };
                    
                    data = {
                        user: userData,
                        referrals: referralsData.referrals || [],
                        referral_stats: referralsData
                    };
                    
                } else if (searchType === 'with_referrals') {
                    // Usuarios con referidos
                    response = await fetch('/api/users/with-referrals');
                    data = await response.json();
                } else if (searchType === 'without_referrals') {
                    // Usuarios sin referidos
                    response = await fetch('/api/users/without-referrals');
                    data = await response.json();
                } else if (searchType === 'referrers') {
                    // Top referidores (ya cargado, solo mostrar)
                    document.getElementById('userDetailsLoading').style.display = 'none';
                    showNotification('üëë Usa la tabla de Top 10 Referidores arriba', 'info');
                    return;
                } else {
                    response = await fetch('/api/all-users');
                    data = await response.json();
                }
                
                document.getElementById('userDetailsLoading').style.display = 'none';
                
                if (data && (!Array.isArray(data) || (searchType === 'all' && data.user) || (Array.isArray(data) && data.length > 0))) {
                    displayUserReferrals(data, searchType);
                } else {
                    document.getElementById('userNoData').style.display = 'block';
                }
                
            } catch (error) {
                console.error('‚ùå Error buscando referidos:', error);
                document.getElementById('userDetailsLoading').style.display = 'none';
                document.getElementById('userNoData').style.display = 'block';
                showNotification('‚ùå Error en la b√∫squeda: ' + error.message, 'error');
            }
        }

        // Buscar usuario por ID espec√≠fico
        async function searchUserById(userId, openInReferralsTab = false) {
            if (openInReferralsTab) {
                // Cambiar a pesta√±a de referidos
                switchTab('referrals');
                setTimeout(() => {
                    document.getElementById('searchUserReferrals').value = userId;
                    document.getElementById('searchType').value = 'all';
                    searchUserReferrals();
                }, 100);
            } else {
                document.getElementById('searchUserReferrals').value = userId;
                document.getElementById('searchType').value = 'all';
                searchUserReferrals();
            }
        }

        // Mostrar referidos de un usuario - CORREGIDA
        function displayUserReferrals(data, searchType) {
            if (searchType === 'all') {
                // Mostrar detalles de un usuario espec√≠fico
                document.getElementById('userDetailsContent').style.display = 'block';
                
                const user = data.user;
                const referrals = data.referrals || [];
                const stats = data.referral_stats || {};
                
                // Informaci√≥n del usuario - CON VALIDACI√ìN
                const userName = user.first_name || user.username || 'Usuario';
                const userUsername = user.username ? `@${user.username}` : 'Sin usuario';
                const userId = user.telegram_id || user.id || 'N/A';
                const userPlan = getPlanName(user.plan) || getPlanName(user.current_plan) || 'Sin plan';
                const referrerInfo = user.referrer_id ? 
                    (user.referrer_username ? `@${user.referrer_username}` : `ID: ${user.referrer_id}`) : 
                    'Directo';
                
                document.getElementById('userName').textContent = userName;
                document.getElementById('userDetails').innerHTML = `
                    <strong>ID:</strong> ${userId}<br>
                    <strong>Usuario:</strong> ${userUsername}<br>
                    <strong>Plan actual:</strong> ${userPlan}<br>
                    <strong>VIP:</strong> ${user.vip ? '‚úÖ S√≠' : '‚ùå No'}<br>
                    <strong>Referidor:</strong> ${referrerInfo}
                `;
                
                // Estad√≠sticas - CON VALIDACI√ìN
                document.getElementById('userTotalReferrals').textContent = stats.total_referrals || stats.level1?.total || 0;
                document.getElementById('userPaidReferrals').textContent = stats.paid_referrals || stats.level1?.paid || 0;
                document.getElementById('userLevel1Referrals').textContent = stats.level1?.total || 0;
                document.getElementById('userLevel2Referrals').textContent = stats.level2?.total || 0;
                
                const discount = ((stats.level1?.paid || 0) * 20) + ((stats.level2?.paid || 0) * 10);
                document.getElementById('userDiscount').textContent = Math.min(discount, 100) + '%';
                
                // Lista de referidos
                const tableBody = document.getElementById('userReferralsTableBody');
                tableBody.innerHTML = '';
                
                if (referrals.length > 0) {
                    referrals.forEach(referral => {
                        const row = document.createElement('tr');
                        const referredUser = referral.referred_name || referral.user_name || 'Usuario';
                        const referredUsername = referral.referred_username ? `@${referral.referred_username}` : '';
                        const referredId = referral.referred_id || 'N/A';
                        const referralLevel = referral.level || 1;
                        const hasPaid = referral.has_paid || false;
                        
                        row.innerHTML = `
                            <td>
                                <strong>${referredUser}</strong>
                                ${referredUsername ? `<br><small>${referredUsername}</small>` : ''}
                                <br><small style="color: #888;">ID: ${referredId}</small>
                            </td>
                            <td>
                                ${referralLevel === 1 ? 
                                    '<span class="badge referral-level-1">Nivel 1</span>' : 
                                    '<span class="badge referral-level-2">Nivel 2</span>'
                                }
                            </td>
                            <td>${getPlanName(referral.plan) || 'Sin plan'}</td>
                            <td>
                                ${hasPaid ? 
                                    '<span class="badge paid">Pagado</span>' : 
                                    '<span class="badge unpaid">No pagado</span>'
                                }
                            </td>
                            <td>
                                ${hasPaid ? 
                                    (referralLevel === 1 ? '20%' : '10%') : 
                                    '0%'
                                }
                            </td>
                            <td>${referral.created_at ? new Date(referral.created_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                <i class="fas fa-user-friends" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>Este usuario no tiene referidos</p>
                            </td>
                        </tr>
                    `;
                }
                
            } else if (searchType === 'with_referrals' || searchType === 'without_referrals') {
                // Mostrar lista de usuarios con/sin referidos
                document.getElementById('userDetailsContent').style.display = 'block';
                document.getElementById('userName').textContent = 
                    searchType === 'with_referrals' ? 'Usuarios con Referidos' : 'Usuarios sin Referidos';
                
                document.getElementById('userDetails').textContent = 
                    searchType === 'with_referrals' ? 
                    `Total: ${data.length} usuarios tienen referidos` : 
                    `Total: ${data.length} usuarios sin referidos`;
                
                // Mostrar tabla con todos los usuarios
                const tableBody = document.getElementById('userReferralsTableBody');
                tableBody.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(user => {
                        const row = document.createElement('tr');
                        const userName = user.first_name || user.username || 'Usuario';
                        const userUsername = user.username ? `@${user.username}` : 'Sin usuario';
                        const userId = user.telegram_id || user.id || 'N/A';
                        
                        row.innerHTML = `
                            <td>
                                <strong>${userName}</strong>
                                ${userUsername !== 'Sin usuario' ? `<br><small>${userUsername}</small>` : ''}
                                <br><small style="color: #888;">ID: ${userId}</small>
                            </td>
                            <td>${user.total_referrals || 0}</td>
                            <td>${user.paid_referrals || 0}</td>
                            <td>${user.level1_referrals || 0}</td>
                            <td>${user.level2_referrals || 0}</td>
                            <td>
                                <button class="action-btn view-details" onclick="searchUserById('${userId}')">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                <i class="fas fa-user-friends" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>No se encontraron usuarios</p>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Limpiar b√∫squeda
        function clearSearch() {
            document.getElementById('searchUserReferrals').value = '';
            document.getElementById('searchType').value = 'all';
            document.getElementById('searchResults').style.display = 'none';
        }

        // Cargar archivos de planes
        async function loadPlanFiles() {
            try {
                console.log('üìÅ Cargando archivos de planes...');
                const response = await fetch('/api/plan-files');
                const planFiles = await response.json();
                
                // Mostrar √°rea de carga mientras se obtienen los datos
                document.getElementById('trialPlanFile').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                document.getElementById('basicPlanFile').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                document.getElementById('advancedPlanFile').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                document.getElementById('premiumPlanFile').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                document.getElementById('annualPlanFile').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                
                // Actualizar informaci√≥n de cada plan
                if (planFiles && Array.isArray(planFiles)) {
                    planFiles.forEach(file => {
                        if (file.plan === 'trial') {
                            document.getElementById('trialPlanFile').textContent = file.filename || 'No subido';
                            document.getElementById('trialPlanDate').textContent = file.updated_at ? 
                                new Date(file.updated_at).toLocaleDateString('es-ES') : 'N/A';
                            document.getElementById('trialUsersCount').textContent = file.users_count || 0;
                            document.getElementById('trialFileName').textContent = file.filename || 'Ninguno';
                        } else {
                            const planFileElement = document.getElementById(`${file.plan}PlanFile`);
                            const planDateElement = document.getElementById(`${file.plan}PlanDate`);
                            const fileNameElement = document.getElementById(`${file.plan}FileName`);
                            
                            if (planFileElement) {
                                planFileElement.textContent = file.filename || 'No subido';
                            }
                            if (planDateElement) {
                                planDateElement.textContent = file.updated_at ? 
                                    new Date(file.updated_at).toLocaleDateString('es-ES') : 'N/A';
                            }
                            if (fileNameElement) {
                                fileNameElement.textContent = file.filename || 'Ninguno';
                            }
                        }
                    });
                } else {
                    console.warn('‚ö†Ô∏è No se recibieron datos de archivos de planes');
                    // Resetear a valores por defecto
                    document.getElementById('trialPlanFile').textContent = 'No subido';
                    document.getElementById('basicPlanFile').textContent = 'No subido';
                    document.getElementById('advancedPlanFile').textContent = 'No subido';
                    document.getElementById('premiumPlanFile').textContent = 'No subido';
                    document.getElementById('annualPlanFile').textContent = 'No subido';
                    
                    document.getElementById('trialPlanDate').textContent = 'N/A';
                    document.getElementById('basicPlanDate').textContent = 'N/A';
                    document.getElementById('advancedPlanDate').textContent = 'N/A';
                    document.getElementById('premiumPlanDate').textContent = 'N/A';
                    document.getElementById('annualPlanDate').textContent = 'N/A';
                    
                    document.getElementById('trialFileName').textContent = 'Ninguno';
                    document.getElementById('basicFileName').textContent = 'Ninguno';
                    document.getElementById('advancedFileName').textContent = 'Ninguno';
                    document.getElementById('premiumFileName').textContent = 'Ninguno';
                    document.getElementById('annualFileName').textContent = 'Ninguno';
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando archivos de planes:', error);
                showNotification('‚ùå Error cargando archivos de planes', 'error');
                
                // En caso de error, mostrar valores por defecto
                document.getElementById('trialPlanFile').textContent = 'Error cargando';
                document.getElementById('basicPlanFile').textContent = 'Error cargando';
                document.getElementById('advancedPlanFile').textContent = 'Error cargando';
                document.getElementById('premiumPlanFile').textContent = 'Error cargando';
                document.getElementById('annualPlanFile').textContent = 'Error cargando';
            }
        }

        // Mostrar modal de estad√≠sticas de archivos
        async function showFilesStatsModal() {
            document.getElementById('filesStatsModal').classList.add('active');
            loadFilesStats();
        }

        // Cerrar modal de estad√≠sticas
        function closeFilesStatsModal() {
            document.getElementById('filesStatsModal').classList.remove('active');
        }

        // Cargar estad√≠sticas de archivos
        async function loadFilesStats() {
            try {
                document.getElementById('filesStatsLoading').style.display = 'block';
                document.getElementById('filesStatsContent').style.display = 'none';
                document.getElementById('filesStatsNoData').style.display = 'none';
                document.getElementById('filesHistoryNoData').style.display = 'none';
                
                console.log('üìä Cargando estad√≠sticas de archivos...');
                
                // Aqu√≠ deber√≠as hacer una llamada a tu API
                // Por ahora, usaremos datos de ejemplo
                const exampleStats = {
                    total_files: 5,
                    total_sent: 150,
                    total_available: 350,
                    total_users: 120,
                    files: [
                        {
                            plan: 'trial',
                            filename: 'config_trial_v2.zip',
                            uploaded_at: '2024-01-15T10:30:00Z',
                            sent_count: 50,
                            available_count: 'Ilimitado',
                            max_uses: null,
                            file_size: 2048576,
                            last_sent: '2024-01-20T14:25:00Z',
                            last_sent_to: 'Usuario Ejemplo',
                            uploaded_by: 'Admin'
                        },
                        {
                            plan: 'basico',
                            filename: 'config_basico_v3.conf',
                            uploaded_at: '2024-01-18T09:15:00Z',
                            sent_count: 45,
                            available_count: 5,
                            max_uses: 50,
                            file_size: 3145728,
                            last_sent: '2024-01-19T16:45:00Z',
                            last_sent_to: 'Juan P√©rez',
                            uploaded_by: 'Admin'
                        },
                        {
                            plan: 'avanzado',
                            filename: 'config_avanzado_v2.rar',
                            uploaded_at: '2024-01-17T14:20:00Z',
                            sent_count: 30,
                            available_count: 20,
                            max_uses: 50,
                            file_size: 5242880,
                            last_sent: '2024-01-20T11:30:00Z',
                            last_sent_to: 'Mar√≠a L√≥pez',
                            uploaded_by: 'Admin'
                        },
                        {
                            plan: 'premium',
                            filename: 'config_premium_v1.zip',
                            uploaded_at: '2024-01-16T11:45:00Z',
                            sent_count: 20,
                            available_count: 30,
                            max_uses: 50,
                            file_size: 4194304,
                            last_sent: '2024-01-19T09:15:00Z',
                            last_sent_to: 'Carlos Rodr√≠guez',
                            uploaded_by: 'Admin'
                        },
                        {
                            plan: 'anual',
                            filename: 'config_anual_2024.conf',
                            uploaded_at: '2024-01-10T08:30:00Z',
                            sent_count: 5,
                            available_count: 45,
                            max_uses: 50,
                            file_size: 6291456,
                            last_sent: '2024-01-18T15:20:00Z',
                            last_sent_to: 'Ana Garc√≠a',
                            uploaded_by: 'Admin'
                        }
                    ],
                    history: [
                        {
                            user_name: 'Juan P√©rez',
                            username: 'juanperez',
                            plan: 'basico',
                            filename: 'config_basico_v3.conf',
                            sent_at: '2024-01-19T16:45:00Z',
                            method: 'manual',
                            status: 'success'
                        },
                        {
                            user_name: 'Mar√≠a L√≥pez',
                            username: 'marialopez',
                            plan: 'avanzado',
                            filename: 'config_avanzado_v2.rar',
                            sent_at: '2024-01-20T11:30:00Z',
                            method: 'manual',
                            status: 'success'
                        },
                        {
                            user_name: 'Carlos Rodr√≠guez',
                            username: 'carlosrod',
                            plan: 'premium',
                            filename: 'config_premium_v1.zip',
                            sent_at: '2024-01-19T09:15:00Z',
                            method: 'manual',
                            status: 'success'
                        },
                        {
                            user_name: 'Pedro S√°nchez',
                            username: 'pedrosan',
                            plan: 'trial',
                            filename: 'config_trial_v2.zip',
                            sent_at: '2024-01-20T14:25:00Z',
                            method: 'trial',
                            status: 'success'
                        },
                        {
                            user_name: 'Ana Garc√≠a',
                            username: 'anagarcia',
                            plan: 'anual',
                            filename: 'config_anual_2024.conf',
                            sent_at: '2024-01-18T15:20:00Z',
                            method: 'manual',
                            status: 'success'
                        }
                    ]
                };
                
                document.getElementById('filesStatsLoading').style.display = 'none';
                document.getElementById('filesStatsContent').style.display = 'block';
                
                // Actualizar resumen general
                updateFilesSummary(exampleStats);
                
                // Actualizar tabla de detalles por plan
                updateFilesStatsTable(exampleStats.files || []);
                
                // Actualizar historial de env√≠os
                updateFilesHistory(exampleStats.history || []);
                
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas de archivos:', error);
                document.getElementById('filesStatsLoading').style.display = 'none';
                showNotification('‚ùå Error cargando estad√≠sticas de archivos', 'error');
            }
        }

        // Actualizar resumen general
        function updateFilesSummary(stats) {
            document.getElementById('totalFilesUploaded').textContent = stats.total_files || 0;
            document.getElementById('totalFilesSent').textContent = stats.total_sent || 0;
            document.getElementById('totalAvailableFiles').textContent = stats.total_available || 0;
            document.getElementById('totalUsersWithFiles').textContent = stats.total_users || 0;
        }

        // Actualizar tabla de detalles por plan
        function updateFilesStatsTable(files) {
            const tableBody = document.getElementById('filesStatsTableBody');
            tableBody.innerHTML = '';
            
            if (!files || files.length === 0) {
                document.getElementById('filesStatsNoData').style.display = 'block';
                return;
            }
            
            document.getElementById('filesStatsNoData').style.display = 'none';
            
            files.forEach(file => {
                const row = document.createElement('tr');
                const sentCount = file.sent_count || 0;
                const availableCount = file.available_count || 'Ilimitado';
                const usagePercentage = file.max_uses ? 
                    Math.round((sentCount / file.max_uses) * 100) : 
                    0;
                
                // Determinar estado basado en uso
                let statusBadge = '';
                
                if (file.max_uses) {
                    if (sentCount >= file.max_uses) {
                        statusBadge = '<span class="badge error">Agotado</span>';
                    } else if (usagePercentage >= 80) {
                        statusBadge = '<span class="badge warning">Por Agotarse</span>';
                    } else {
                        statusBadge = '<span class="badge success">Disponible</span>';
                    }
                } else {
                    statusBadge = '<span class="badge">Ilimitado</span>';
                }
                
                // Determinar color de la barra de progreso
                let progressColor = '';
                if (usagePercentage >= 90) {
                    progressColor = '#ef4444';
                } else if (usagePercentage >= 75) {
                    progressColor = '#f59e0b';
                } else if (usagePercentage >= 50) {
                    progressColor = '#3b82f6';
                } else {
                    progressColor = '#10b981';
                }
                
                row.innerHTML = `
                    <td>
                        <strong>${getPlanName(file.plan)}</strong>
                        ${file.plan === 'trial' ? '<br><span class="badge trial-file">PRUEBA</span>' : ''}
                        ${file.plan === 'anual' ? '<br><span class="badge anual">ANUAL</span>' : ''}
                    </td>
                    <td>
                        <div class="filename-display">${file.filename || 'No subido'}</div>
                        ${file.file_size ? `<small style="color: #888;">${formatFileSize(file.file_size)}</small>` : ''}
                    </td>
                    <td>
                        ${file.uploaded_at ? new Date(file.uploaded_at).toLocaleDateString('es-ES') : 'N/A'}
                        ${file.uploaded_by ? `<br><small style="color: #888;">Por: ${file.uploaded_by}</small>` : ''}
                    </td>
                    <td>
                        <strong>${sentCount}</strong> env√≠os
                        ${file.max_uses ? `<br><small style="color: #888;">M√°ximo: ${file.max_uses}</small>` : ''}
                    </td>
                    <td>
                        ${availableCount}
                        ${file.max_uses ? 
                            `<div class="progress-container" style="margin-top: 5px;">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${usagePercentage}%; background: ${progressColor}"></div>
                                </div>
                                <div class="progress-info">
                                    <span class="progress-text">Uso</span>
                                    <span class="progress-percent">${usagePercentage}%</span>
                                </div>
                            </div>` : 
                            ''
                        }
                    </td>
                    <td>
                        ${file.last_sent ? new Date(file.last_sent).toLocaleDateString('es-ES') : 'Nunca'}
                        ${file.last_sent_to ? `<br><small style="color: #888;">A: ${file.last_sent_to}</small>` : ''}
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="action-btn view-details" onclick="viewFileDetails('${file.plan}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${file.plan !== 'trial' ? 
                            `<button class="action-btn message" onclick="renewFile('${file.plan}')" title="Renovar archivo">
                                <i class="fas fa-redo"></i>
                            </button>` : 
                            ''
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Actualizar historial de env√≠os
        function updateFilesHistory(history) {
            const tableBody = document.getElementById('filesHistoryTableBody');
            tableBody.innerHTML = '';
            
            if (!history || history.length === 0) {
                document.getElementById('filesHistoryNoData').style.display = 'block';
                return;
            }
            
            document.getElementById('filesHistoryNoData').style.display = 'none';
            
            // Mostrar solo los √∫ltimos 20 env√≠os
            const recentHistory = history.slice(0, 20);
            
            recentHistory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${item.user_name || 'Usuario'}</strong>
                        ${item.username ? `<br><small>@${item.username}</small>` : ''}
                    </td>
                    <td>${getPlanName(item.plan)}</td>
                    <td>
                        <div class="filename-display" style="font-size: 0.85rem;">${item.filename || 'N/A'}</div>
                    </td>
                    <td>${item.sent_at ? new Date(item.sent_at).toLocaleString('es-ES') : 'N/A'}</td>
                    <td>${getDeliveryMethodBadge(item.method)}</td>
                    <td>
                        ${item.status === 'success' ? 
                            '<span class="badge success">Entregado</span>' : 
                            '<span class="badge error">Fallido</span>'
                        }
                        ${item.error ? `<br><small style="color: #f87171;">${item.error}</small>` : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Ver detalles de un archivo espec√≠fico
        async function viewFileDetails(plan) {
            try {
                // Datos de ejemplo
                const details = {
                    plan: plan,
                    filename: `config_${plan}_v2.zip`,
                    file_size: 3145728,
                    uploaded_at: '2024-01-18T09:15:00Z',
                    sent_count: 45,
                    available_count: 5,
                    max_uses: 50,
                    recent_sent: [
                        {
                            user_name: 'Juan P√©rez',
                            sent_at: '2024-01-19T16:45:00Z',
                            method: 'manual',
                            status: 'success'
                        },
                        {
                            user_name: 'Mar√≠a L√≥pez',
                            sent_at: '2024-01-18T14:30:00Z',
                            method: 'manual',
                            status: 'success'
                        },
                        {
                            user_name: 'Carlos Rodr√≠guez',
                            sent_at: '2024-01-17T11:20:00Z',
                            method: 'manual',
                            status: 'success'
                        }
                    ],
                    usage_stats: {
                        'Enero 2024': 25,
                        'Diciembre 2023': 20,
                        'Total mensual': 45
                    }
                };
                
                // Crear modal con detalles
                const modalContent = `
                    <div style="padding: 20px;">
                        <h3 style="margin-bottom: 15px; color: var(--text);">
                            <i class="fas fa-file-alt"></i> Detalles de ${getPlanName(plan)}
                        </h3>
                        
                        <div class="file-info-grid">
                            <div class="file-info-item">
                                <div class="file-info-label">Archivo</div>
                                <div class="file-info-value filename-display">${details.filename || 'No subido'}</div>
                            </div>
                            <div class="file-info-item">
                                <div class="file-info-label">Tama√±o</div>
                                <div class="file-info-value">${details.file_size ? formatFileSize(details.file_size) : 'N/A'}</div>
                            </div>
                            <div class="file-info-item">
                                <div class="file-info-label">Env√≠os Totales</div>
                                <div class="file-info-value">${details.sent_count || 0}</div>
                            </div>
                            <div class="file-info-item">
                                <div class="file-info-label">Disponibles</div>
                                <div class="file-info-value">${details.available_count || 'Ilimitado'}</div>
                            </div>
                            <div class="file-info-item">
                                <div class="file-info-label">Subido</div>
                                <div class="file-info-value">${details.uploaded_at ? new Date(details.uploaded_at).toLocaleDateString('es-ES') : 'N/A'}</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 15px 0 10px 0; color: var(--text);">√öltimos 10 env√≠os:</h4>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Fecha</th>
                                        <th>M√©todo</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${details.recent_sent && details.recent_sent.length > 0 ? 
                                        details.recent_sent.map(sent => `
                                            <tr>
                                                <td>${sent.user_name || 'Usuario'}</td>
                                                <td>${new Date(sent.sent_at).toLocaleString('es-ES')}</td>
                                                <td>${getDeliveryMethodBadge(sent.method)}</td>
                                                <td>${sent.status === 'success' ? 
                                                    '<span class="badge success">‚úì</span>' : 
                                                    '<span class="badge error">‚úó</span>'
                                                }</td>
                                            </tr>
                                        `).join('') : 
                                        `<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay env√≠os recientes</td></tr>`
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
                            <button class="action-btn send-config" onclick="downloadFileStats('${plan}')" style="width: 100%;">
                                <i class="fas fa-download"></i> Descargar Reporte
                            </button>
                        </div>
                    </div>
                `;
                
                // Mostrar en modal personalizado
                showCustomModal(`Detalles de ${getPlanName(plan)}`, modalContent);
                
            } catch (error) {
                console.error('‚ùå Error cargando detalles del archivo:', error);
                showNotification('‚ùå Error cargando detalles del archivo', 'error');
            }
        }

        // Renovar archivo (subir nueva versi√≥n)
        function renewFile(plan) {
            if (confirm(`¬øSubir nueva versi√≥n del archivo para ${getPlanName(plan)}?\n\nEl archivo actual seguir√° disponible para usuarios que ya lo recibieron.`)) {
                openPlanFileUpload(plan);
            }
        }

        // Descargar reporte de archivo
        async function downloadFileStats(plan) {
            try {
                // Crear contenido para descarga
                const report = `
REPORTE DE ARCHIVO - ${getPlanName(plan).toUpperCase()}
Fecha: ${new Date().toLocaleDateString('es-ES')}
==============================================

INFORMACI√ìN DEL ARCHIVO:
- Nombre: config_${plan}_v2.zip
- Plan: ${getPlanName(plan)}
- Subido: ${new Date().toLocaleString('es-ES')}
- Tama√±o: ${formatFileSize(3145728)}
- Env√≠os totales: 45
- Disponibles: 5

ESTAD√çSTICAS DE USO:
- Enero 2024: 25
- Diciembre 2023: 20
- Total mensual: 45

√öLTIMOS ENV√çOS:
- ${new Date('2024-01-19T16:45:00Z').toLocaleString('es-ES')} | Juan P√©rez | manual | success
- ${new Date('2024-01-18T14:30:00Z').toLocaleString('es-ES')} | Mar√≠a L√≥pez | manual | success
- ${new Date('2024-01-17T11:20:00Z').toLocaleString('es-ES')} | Carlos Rodr√≠guez | manual | success

==============================================
Generado por VPN Cuba Admin Panel
`;
                
                // Crear y descargar archivo
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte-${plan}-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('‚úÖ Reporte descargado', 'success');
                
            } catch (error) {
                console.error('‚ùå Error descargando reporte:', error);
                showNotification('‚ùå Error descargando reporte', 'error');
            }
        }

        // Mostrar modal personalizado
        function showCustomModal(title, content) {
            const modalId = 'customModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="close-modal" onclick="document.getElementById('${modalId}').classList.remove('active')">&times;</button>
                        </div>
                        <div id="${modalId}Content"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById(`${modalId}Content`).innerHTML = content;
            modal.classList.add('active');
        }

        // Funci√≥n auxiliar para formatear tama√±o de archivo
        function formatFileSize(bytes) {
            if (!bytes) return '0 Bytes';
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Funci√≥n para obtener badge de m√©todo de entrega
        function getDeliveryMethodBadge(method) {
            const badges = {
                'manual': '<span class="badge manual">Manual</span>',
                'auto': '<span class="badge auto">Autom√°tico</span>',
                'trial': '<span class="badge trial">Prueba</span>',
                'usdt': '<span class="badge usdt">USDT</span>',
                'broadcast': '<span class="badge broadcast">Broadcast</span>'
            };
            return badges[method] || `<span class="badge">${method}</span>`;
        }

        // Abrir upload de archivo para plan
        function openPlanFileUpload(plan) {
            console.log(`üìÅ Abriendo selector para plan: ${plan}`);
            
            // Mapeo de nombres de plan a IDs de inputs
            const planToInputId = {
                'basico': 'basicPlanFileInput',
                'avanzado': 'advancedPlanFileInput', 
                'premium': 'premiumPlanFileInput',
                'anual': 'annualPlanFileInput'
            };
            
            const fileInputId = planToInputId[plan];
            
            if (!fileInputId) {
                console.error(`‚ùå No se encontr√≥ ID para plan: ${plan}`);
                showNotification(`‚ùå Error: Plan ${plan} no reconocido`, 'error');
                return;
            }
            
            const fileInput = document.getElementById(fileInputId);
            
            if (fileInput) {
                currentPlanForUpload = plan;
                // Limpiar el input
                fileInput.value = '';
                console.log(`‚úÖ Input encontrado: ${fileInputId}`);
                
                // Disparar el click program√°ticamente
                fileInput.click();
            } else {
                console.error(`‚ùå No se encontr√≥ el elemento con ID: ${fileInputId}`);
                showNotification('‚ùå Error al abrir selector de archivos', 'error');
            }
        }

        // Abrir upload de archivo de prueba
        function openTrialFileUpload() {
            console.log('üéÅ Abriendo selector para archivo de prueba');
            
            const fileInput = document.getElementById('trialPlanFileInput');
            
            if (fileInput) {
                currentPlanForUpload = 'trial';
                // Limpiar el input
                fileInput.value = '';
                console.log('‚úÖ Input de prueba encontrado');
                
                // Disparar el click program√°ticamente
                fileInput.click();
            } else {
                console.error('‚ùå No se encontr√≥ el input de prueba');
                showNotification('‚ùå Error al abrir selector de archivos de prueba', 'error');
            }
        }

        // Subir archivo de plan
        async function uploadPlanFile(event) {
            console.log('üì§ Iniciando subida de archivo...');
            
            if (!currentPlanForUpload) {
                console.error('‚ùå currentPlanForUpload no est√° definido');
                showNotification('‚ùå Error: No se seleccion√≥ un plan', 'warning');
                return;
            }
            
            console.log(`üìÅ Plan seleccionado: ${currentPlanForUpload}`);
            
            // Determinar el ID del input
            let fileInputId = '';
            if (currentPlanForUpload === 'trial') {
                fileInputId = 'trialPlanFileInput';
            } else {
                const planToInputId = {
                    'basico': 'basicPlanFileInput',
                    'avanzado': 'advancedPlanFileInput', 
                    'premium': 'premiumPlanFileInput',
                    'anual': 'annualPlanFileInput'
                };
                fileInputId = planToInputId[currentPlanForUpload];
            }
            
            if (!fileInputId) {
                console.error(`‚ùå No se encontr√≥ ID para plan: ${currentPlanForUpload}`);
                showNotification('‚ùå Error: Plan no reconocido', 'error');
                return;
            }
            
            const fileInput = document.getElementById(fileInputId);
            
            if (!fileInput) {
                console.error(`‚ùå No se encontr√≥ input con ID: ${fileInputId}`);
                showNotification('‚ùå Error: No se pudo encontrar el selector de archivos', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('‚ùå No se seleccion√≥ ning√∫n archivo', 'warning');
                return;
            }
            
            // Validar tipo de archivo
            const fileName = file.name.toLowerCase();
            const isValidFile = fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.conf');
            
            if (!isValidFile) {
                showNotification('‚ùå Solo se permiten archivos .conf, .zip o .rar', 'warning');
                fileInput.value = '';
                return;
            }
            
            // Validar tama√±o (10MB m√°ximo)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showNotification('‚ùå El archivo es demasiado grande (m√°ximo 10MB)', 'warning');
                fileInput.value = '';
                return;
            }
            
            const isTrial = currentPlanForUpload === 'trial';
            console.log(`üì§ Subiendo archivo: ${file.name} (${formatBytes(file.size)}) para ${isTrial ? 'prueba' : 'plan ' + currentPlanForUpload}`);
            
            // Mostrar notificaci√≥n
            showNotification(`‚è≥ Subiendo ${file.name}...`, 'info');
            
            const formData = new FormData();
            formData.append('plan', currentPlanForUpload);
            formData.append('file', file);
            formData.append('adminId', currentUserId);
            
            try {
                const endpoint = isTrial ? '/api/upload-trial-file' : '/api/upload-plan-file';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Archivo subido:', result);
                    
                    const planName = isTrial ? 'prueba gratuita' : getPlanName(currentPlanForUpload);
                    showNotification(`‚úÖ Archivo subido para ${planName}`, 'success');
                    
                    // Actualizar UI inmediatamente
                    updatePlanFileUI(currentPlanForUpload, file.name);
                    
                    // Recargar lista completa
                    setTimeout(() => loadPlanFiles(), 1000);
                    
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error en respuesta:', errorText);
                    throw new Error(errorText || 'Error subiendo archivo');
                }
                
            } catch (error) {
                console.error('‚ùå Error subiendo archivo:', error);
                showNotification('‚ùå Error subiendo archivo: ' + error.message, 'error');
            } finally {
                // Limpiar
                fileInput.value = '';
                currentPlanForUpload = null;
            }
        }

        // Funci√≥n para actualizar UI despu√©s de subir
        function updatePlanFileUI(plan, fileName) {
            // Mapeo de plan a elementos UI
            const planToUI = {
                'trial': {
                    file: 'trialPlanFile',
                    date: 'trialPlanDate',
                    fileName: 'trialFileName'
                },
                'basico': {
                    file: 'basicPlanFile',
                    date: 'basicPlanDate',
                    fileName: 'basicFileName'
                },
                'avanzado': {
                    file: 'advancedPlanFile',
                    date: 'advancedPlanDate',
                    fileName: 'advancedFileName'
                },
                'premium': {
                    file: 'premiumPlanFile',
                    date: 'premiumPlanDate',
                    fileName: 'premiumFileName'
                },
                'anual': {
                    file: 'annualPlanFile',
                    date: 'annualPlanDate',
                    fileName: 'annualFileName'
                }
            };
            
            const uiElements = planToUI[plan];
            if (uiElements) {
                const fileElement = document.getElementById(uiElements.file);
                const dateElement = document.getElementById(uiElements.date);
                const fileNameElement = document.getElementById(uiElements.fileName);
                
                if (fileElement) {
                    fileElement.textContent = fileName;
                }
                if (dateElement) {
                    dateElement.textContent = new Date().toLocaleDateString('es-ES');
                }
                if (fileNameElement) {
                    fileNameElement.textContent = fileName;
                }
            }
        }

        // Funci√≥n auxiliar para formatear bytes
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Cargar estad√≠sticas de juegos
        async function loadGamesStats() {
            try {
                document.getElementById('gamesLoading').style.display = 'block';
                document.getElementById('gamesTable').style.display = 'none';
                document.getElementById('gamesNoData').style.display = 'none';
                
                console.log('üéÆ Cargando estad√≠sticas de juegos...');
                const response = await fetch('/api/games-stats');
                const games = await response.json();
                
                document.getElementById('gamesLoading').style.display = 'none';
                
                if (!games || games.length === 0) {
                    document.getElementById('gamesNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('gamesTableBody');
                tableBody.innerHTML = '';
                
                games.forEach(game => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${game.game_server || 'No especificado'}</td>
                        <td>${game.request_count || 0}</td>
                        <td>${game.connection_types?.join(', ') || 'No especificado'}</td>
                        <td>${game.last_request ? new Date(game.last_request).toLocaleDateString('es-ES') : 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('gamesTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando estad√≠sticas de juegos:', error);
                document.getElementById('gamesLoading').style.display = 'none';
                showNotification('‚ùå Error cargando estad√≠sticas de juegos', 'error');
            }
        }

        // Cargar historial de broadcasts
        async function loadBroadcasts() {
            try {
                document.getElementById('broadcastLoading').style.display = 'block';
                document.getElementById('broadcastTable').style.display = 'none';
                document.getElementById('broadcastNoData').style.display = 'none';
                
                console.log('üì¢ Cargando historial de broadcasts...');
                const response = await fetch('/api/broadcasts');
                const broadcasts = await response.json();
                
                document.getElementById('broadcastLoading').style.display = 'none';
                
                if (!broadcasts || broadcasts.length === 0) {
                    document.getElementById('broadcastNoData').style.display = 'block';
                    return;
                }
                
                const tableBody = document.getElementById('broadcastTableBody');
                tableBody.innerHTML = '';
                
                broadcasts.forEach(broadcast => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${broadcast.id || 'N/A'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${broadcast.message}">
                            ${truncateText(broadcast.message, 50)}
                        </td>
                        <td>${getBroadcastTargetName(broadcast.target)}</td>
                        <td>${broadcast.sent_count || 0}/${broadcast.total_users || 0}</td>
                        <td>
                            ${broadcast.status === 'completed' ? 
                                '<span class="badge completed">Completado</span>' : 
                                '<span class="badge pending">Pendiente</span>'
                            }
                        </td>
                        <td>${broadcast.created_at ? new Date(broadcast.created_at).toLocaleDateString('es-ES') : 'N/A'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                document.getElementById('broadcastTable').style.display = 'table';
                
            } catch (error) {
                console.error('‚ùå Error cargando broadcasts:', error);
                document.getElementById('broadcastLoading').style.display = 'none';
                showNotification('‚ùå Error cargando broadcasts', 'error');
            }
        }

        // Enviar broadcast
        async function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            const target = document.getElementById('broadcastTarget').value;
            
            if (!message) {
                showNotification('‚ùå Escribe un mensaje para enviar', 'warning');
                return;
            }
            
            if (!confirm(`¬øEst√°s seguro de enviar este broadcast a ${getBroadcastTargetName(target)}?`)) {
                return;
            }
            
            const button = document.getElementById('broadcastButton');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            
            try {
                const response = await fetch('/api/broadcast/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        target: target,
                        adminId: currentUserId
                    })
                });
                
                if (response.ok) {
                    showNotification('‚úÖ Broadcast enviado correctamente', 'success');
                    document.getElementById('broadcastMessage').value = '';
                    loadBroadcasts();
                } else {
                    throw new Error('Error enviando broadcast');
                }
            } catch (error) {
                console.error('‚ùå Error enviando broadcast:', error);
                showNotification('‚ùå Error enviando broadcast: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Broadcast';
            }
        }

        // Abrir modal de configuraci√≥n
        function openConfigModal(paymentId, telegramId, plan) {
            currentPaymentId = paymentId;
            
            document.getElementById('configPaymentId').textContent = paymentId;
            document.getElementById('configUserId').textContent = telegramId;
            document.getElementById('configPlan').textContent = getPlanName(plan);
            
            document.getElementById('configModal').classList.add('active');
        }

        // Enviar configuraci√≥n de prueba - CORREGIDA
        async function sendTrialConfig(telegramId, userName) {
            if (!confirm(`¬øEnviar configuraci√≥n de prueba a ${userName}?\n\nSe enviar√° el archivo de prueba actual.`)) return;
            
            try {
                showNotification(`‚è≥ Enviando prueba a ${userName}...`, 'info');
                
                // Primero, verificar si hay archivo de prueba
                const planFileResponse = await fetch('/api/plan-files/trial');
                const planFileData = await planFileResponse.json();
                
                if (!planFileData || !planFileData.public_url) {
                    showNotification('‚ùå No hay archivo de prueba disponible. Sube uno primero.', 'error');
                    return;
                }
                
                // Enviar archivo al usuario
                const response = await fetch('/api/send-trial-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegramId: telegramId,
                        adminId: currentUserId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification(`‚úÖ Configuraci√≥n de prueba enviada a ${userName}`, 'success');
                        // Recargar lista de pruebas pendientes
                        loadPendingTrials();
                    } else {
                        showNotification(`‚ö†Ô∏è ${result.message || 'Error enviando prueba'}`, 'warning');
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Error enviando configuraci√≥n de prueba');
                }
            } catch (error) {
                console.error('‚ùå Error enviando configuraci√≥n de prueba:', error);
                showNotification('‚ùå Error enviando configuraci√≥n de prueba: ' + error.message, 'error');
            }
        }

        // Aprobar pago - FUNCI√ìN MODIFICADA PARA FLUJO MANUAL
        async function approvePayment(paymentId) {
            if (!confirm('¬øEst√°s seguro de aprobar este pago?\n\n# El archivo NO se enviar√° autom√°ticamente.\nDebes enviarlo manualmente desde la pesta√±a "Pagos Aprobados".')) return;
            
            try {
                showNotification('‚è≥ Aprobando pago...', 'info');
                
                const response = await fetch(`/api/payments/${paymentId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminId: currentUserId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('‚úÖ Pago aprobado. Env√≠a el archivo manualmente desde "Pagos Aprobados".', 'success');
                    closeModal();
                    loadPendingPayments();
                    loadApprovedPayments();
                    loadStats();
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Error aprobando pago');
                }
            } catch (error) {
                console.error('‚ùå Error aprobando pago:', error);
                showNotification('‚ùå Error aprobando pago: ' + error.message, 'error');
            }
        }

        // Rechazar pago
        async function rejectPayment(paymentId) {
            const reason = prompt('Ingresa el motivo del rechazo:');
            if (!reason) return;
            
            try {
                showNotification('‚è≥ Rechazando pago...', 'info');
                
                const response = await fetch(`/api/payments/${paymentId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        reason: reason,
                        adminId: currentUserId 
                    })
                });
                
                if (response.ok) {
                    showNotification('‚úÖ Pago rechazado correctamente', 'success');
                    closeModal();
                    loadPendingPayments();
                    loadStats();
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Error rechazando pago');
                }
            } catch (error) {
                console.error('‚ùå Error rechazando pago:', error);
                showNotification('‚ùå Error rechazando pago: ' + error.message, 'error');
            }
        }

        // Enviar archivo de configuraci√≥n (CORREGIDO PARA ENV√çO MANUAL)
        async function sendConfigFile() {
            const fileInput = document.getElementById('configFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('‚ùå Selecciona un archivo de configuraci√≥n', 'warning');
                return;
            }
            
            // Validar que sea ZIP, RAR o CONF
            const fileName = file.name.toLowerCase();
            const isValidFile = fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.conf');
            
            if (!isValidFile) {
                showNotification('‚ùå Solo se permiten archivos .conf, .zip o .rar', 'warning');
                fileInput.value = '';
                return;
            }
            
            // Validar tama√±o (10MB m√°ximo)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showNotification('‚ùå El archivo es demasiado grande (m√°ximo 10MB)', 'warning');
                fileInput.value = '';
                return;
            }
            
            showNotification('‚è≥ Enviando configuraci√≥n manualmente...', 'info');
            
            const formData = new FormData();
            formData.append('configFile', file);
            formData.append('paymentId', currentPaymentId);
            formData.append('adminId', currentUserId);
            
            try {
                const response = await fetch('/api/send-config', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification('‚úÖ Configuraci√≥n enviada manualmente', 'success');
                    } else {
                        showNotification(`‚ö†Ô∏è ${result.message || 'Error enviando configuraci√≥n'}`, 'warning');
                    }
                    closeConfigModal();
                    loadApprovedPayments();
                    fileInput.value = '';
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Error enviando configuraci√≥n');
                }
            } catch (error) {
                console.error('‚ùå Error enviando configuraci√≥n:', error);
                showNotification('‚ùå Error enviando configuraci√≥n: ' + error.message, 'error');
            }
        }

        // Cerrar modales
        function closeModal() {
            document.getElementById('screenshotModal').classList.remove('active');
            currentPaymentMethod = null;
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
            document.getElementById('configFile').value = '';
        }

        // Mostrar notificaci√≥n
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, type === 'error' ? 10000 : 5000);
        }

        // Cambiar pesta√±as
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.getElementById(tabName + 'Content').style.display = 'block';
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            currentTab = tabName;
            
            switch(tabName) {
                case 'pending':
                    loadPendingPayments();
                    break;
                case 'trial-pending':
                    loadPendingTrials();
                    break;
                case 'approved':
                    loadApprovedPayments();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'referrals':
                    loadReferrals();
                    break;
                case 'plan-files':
                    loadPlanFiles();
                    break;
                case 'games':
                    loadGamesStats();
                    break;
                case 'broadcast':
                    loadBroadcasts();
                    break;
                case 'stats':
                    loadStats();
                    break;
            }
        }

        // Obtener nombre del plan
        function getPlanName(planType) {
            const plans = {
                'basico': 'B√°sico (1 mes)',
                'avanzado': 'Avanzado (2 meses)',
                'premium': 'Premium (1 mes)',
                'anual': 'Anual (12 meses)',
                'trial': 'Prueba Gratuita'
            };
            return plans[planType] || planType;
        }

        // Obtener badge de m√©todo de pago
        function getPaymentMethodBadge(method) {
            const badges = {
                'transfer': '<span class="badge">BPA</span>',
                'metropolitan': '<span class="badge">Metropolitana</span>',
                'mitransfer': '<span class="badge">MITRANSFER</span>',
                'mobile': '<span class="badge">Saldo M√≥vil</span>',
                'usdt': '<span class="badge usdt">USDT</span>'
            };
            return badges[method] || `<span class="badge">${method}</span>`;
        }

        // Obtener nombre del target de broadcast
        function getBroadcastTargetName(target) {
            const targets = {
                'all': 'üë• Todos los usuarios',
                'vip': 'üëë Solo usuarios VIP',
                'non_vip': 'üë§ Usuarios no VIP',
                'trial_pending': '‚è≥ Pruebas pendientes',
                'trial_received': '‚úÖ Pruebas recibidas',
                'active': 'üì± Usuarios activos',
                'with_referrals': 'ü§ù Con referidos',
                'usdt_payers': 'üí∞ Pagaron con USDT'
            };
            return targets[target] || target;
        }

        // Truncar texto
        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // Manejar el cambio en inputs de archivo
        function handleFileInputChange(event) {
            console.log('üìÑ Input de archivo cambiado');
            
            const input = event.target;
            if (!input || !input.files || input.files.length === 0) {
                console.log('‚ö†Ô∏è No hay archivos seleccionados');
                return;
            }
            
            const file = input.files[0];
            console.log(`üìÑ Archivo seleccionado: ${file.name} (${formatBytes(file.size)})`);
            
            // Detectar plan basado en el ID del input
            const inputId = input.id;
            console.log(`üÜî ID del input: ${inputId}`);
            
            let plan = '';
            
            // Determinar el plan basado en el ID
            if (inputId === 'trialPlanFileInput') plan = 'trial';
            else if (inputId === 'basicPlanFileInput') plan = 'basico';
            else if (inputId === 'advancedPlanFileInput') plan = 'avanzado';
            else if (inputId === 'premiumPlanFileInput') plan = 'premium';
            else if (inputId === 'annualPlanFileInput') plan = 'anual';
            
            if (!plan) {
                console.error('‚ùå No se pudo determinar el plan del input:', inputId);
                showNotification('‚ùå Error al identificar el plan', 'error');
                return;
            }
            
            console.log(`üéØ Plan detectado: ${plan}`);
            
            // Establecer plan actual
            currentPlanForUpload = plan;
            
            // Validar archivo inmediatamente
            const fileName = file.name.toLowerCase();
            const isValidFile = fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.conf');
            
            if (!isValidFile) {
                showNotification('‚ùå Solo se permiten .conf, .zip o .rar', 'warning');
                input.value = '';
                currentPlanForUpload = null;
                return;
            }
            
            // Validar tama√±o
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showNotification('‚ùå Archivo muy grande (m√°x 10MB)', 'warning');
                input.value = '';
                currentPlanForUpload = null;
                return;
            }
            
            // Proceder con la subida
            uploadPlanFile(event);
        }

        // Configurar eventos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeConfigModal();
                closeUserDetailsModal();
                closeFilesStatsModal();
                const customModal = document.getElementById('customModal');
                if (customModal) customModal.classList.remove('active');
            }
        });

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ Panel de administraci√≥n cargado');
            
            checkAdminAccess();
            
            // Configurar eventos de pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Configurar eventos de inputs de archivo
            console.log('üîß Configurando eventos de inputs de archivo...');
            
            const fileInputs = [
                'trialPlanFileInput',
                'basicPlanFileInput',
                'advancedPlanFileInput', 
                'premiumPlanFileInput',
                'annualPlanFileInput'
            ];
            
            fileInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // Remover cualquier listener previo (para evitar duplicados)
                    input.removeEventListener('change', handleFileInputChange);
                    // Agregar nuevo listener
                    input.addEventListener('change', handleFileInputChange);
                    console.log(`‚úÖ Evento configurado para: ${inputId}`);
                } else {
                    console.error(`‚ùå Input NO encontrado: ${inputId}`);
                }
            });
            
            // Auto-refresh cada 30 segundos
            setInterval(() => {
                if (currentTab === 'stats') {
                    loadStats();
                }
            }, 30000);
        });
    </script>
</body>
</html>
