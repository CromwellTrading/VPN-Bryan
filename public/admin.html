<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN Cuba - Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo-glow"></div>
                <h1>VPN CUBA - ADMIN</h1>
            </div>
            <p class="subtitle">Panel de administraci√≥n</p>
            <div class="admin-actions">
                <button class="btn-secondary" onclick="refreshData()">
                    <span class="btn-icon">üîÑ</span>
                    <span class="btn-text">Actualizar</span>
                </button>
            </div>
        </div>
        
        <!-- Verificar si es admin -->
        <div id="adminCheck" style="display: none;">
            <div class="admin-check-container">
                <div class="admin-check-icon">üîí</div>
                <div class="admin-check-text">Verificando acceso...</div>
            </div>
        </div>
        
        <!-- Contenido admin (solo visible si es admin) -->
        <div id="adminContent" style="display: none;">
            <!-- Secci√≥n de Pagos Pendientes -->
            <div class="admin-section">
                <h2 class="section-title">
                    <span class="section-icon">‚è≥</span>
                    Pagos Pendientes
                    <span class="badge" id="pendingCount">0</span>
                </h2>
                
                <div class="payments-grid" id="pendingPayments">
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-text">No hay pagos pendientes</div>
                    </div>
                </div>
            </div>
            
            <!-- Secci√≥n de Enviar Configuraci√≥n -->
            <div class="admin-section">
                <h2 class="section-title">
                    <span class="section-icon">üì§</span>
                    Enviar Configuraci√≥n
                </h2>
                
                <div class="config-form">
                    <div class="form-group">
                        <label for="userSearch">ID de Telegram del usuario:</label>
                        <input type="text" id="userSearch" class="form-input" 
                               placeholder="Ej: 123456789">
                    </div>
                    
                    <div class="form-group">
                        <label>Notas (opcional):</label>
                        <textarea id="adminNotes" class="form-textarea" 
                                  placeholder="Notas para el usuario..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <p><strong>Instrucciones:</strong></p>
                        <ol class="instructions-list">
                            <li>Busca al usuario en Telegram</li>
                            <li>Env√≠a el archivo de configuraci√≥n (.conf)</li>
                            <li>El bot lo registrar√° autom√°ticamente</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <!-- Secci√≥n de Usuarios VIP -->
            <div class="admin-section">
                <h2 class="section-title">
                    <span class="section-icon">üëë</span>
                    Usuarios VIP
                    <span class="badge" id="vipCount">0</span>
                </h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalRevenue">$0</div>
                            <div class="stat-label">Ingresos totales</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-label">Usuarios totales</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <div class="stat-value" id="approvedToday">0</div>
                            <div class="stat-label">Aprobados hoy</div>
                        </div>
                    </div>
                </div>
                
                <div class="vip-list" id="vipUsers">
                    <div class="empty-state">
                        <div class="empty-icon">üëë</div>
                        <div class="empty-text">No hay usuarios VIP a√∫n</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- No es admin -->
        <div id="notAdmin" style="display: none;">
            <div class="error-container">
                <div class="error-icon">üö´</div>
                <h2 class="error-title">Acceso denegado</h2>
                <p class="error-text">Solo el administrador puede acceder a esta p√°gina.</p>
                <button class="btn-primary" onclick="goBack()">
                    <span class="btn-icon">‚Üê</span>
                    <span class="btn-text">Volver</span>
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p class="footer-text">¬© 2025 VPN Cuba - Panel de Administraci√≥n</p>
        </div>
    </div>

    <script>
        // Inicializar Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();
        
        // Obtener par√°metros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId') || tg.initDataUnsafe.user?.id;
        const ADMIN_ID = '6373481979'; // Tu ID de admin
        
        // Verificar si es admin
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
        });
        
        async function checkAdminAccess() {
            const adminCheck = document.getElementById('adminCheck');
            const adminContent = document.getElementById('adminContent');
            const notAdmin = document.getElementById('notAdmin');
            
            adminCheck.style.display = 'block';
            
            // Simular verificaci√≥n (en producci√≥n esto ser√≠a en el backend)
            setTimeout(() => {
                adminCheck.style.display = 'none';
                
                if (userId === ADMIN_ID) {
                    adminContent.style.display = 'block';
                    loadAdminData();
                } else {
                    notAdmin.style.display = 'block';
                }
            }, 1000);
        }
        
        async function loadAdminData() {
            await loadPayments();
            await loadStats();
            await loadVIPUsers();
        }
        
        // Cargar pagos pendientes
        async function loadPayments() {
            try {
                const response = await fetch('/api/payments/pending');
                const payments = await response.json();
                displayPayments(payments);
            } catch (error) {
                console.error('Error cargando pagos:', error);
            }
        }
        
        // Mostrar pagos en la interfaz
        function displayPayments(payments) {
            const container = document.getElementById('pendingPayments');
            const countElement = document.getElementById('pendingCount');
            
            countElement.textContent = payments.length;
            
            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-text">No hay pagos pendientes</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            payments.forEach(payment => {
                const paymentElement = document.createElement('div');
                paymentElement.className = 'payment-card';
                paymentElement.innerHTML = `
                    <div class="payment-header">
                        <div class="payment-id">#${payment.id.substring(0, 8)}</div>
                        <div class="payment-date">${new Date(payment.created_at).toLocaleDateString()}</div>
                    </div>
                    
                    <div class="payment-body">
                        <div class="payment-user">
                            <div class="user-icon">üë§</div>
                            <div class="user-info">
                                <div class="user-id">ID: ${payment.telegram_id}</div>
                                <div class="user-plan">Plan: ${getPlanName(payment.plan)}</div>
                            </div>
                        </div>
                        
                        <div class="payment-amount">
                            <div class="amount-icon">üí∞</div>
                            <div class="amount-value">$${payment.price} CUP</div>
                        </div>
                    </div>
                    
                    <div class="payment-screenshot">
                        <div class="screenshot-label">Comprobante:</div>
                        <img src="${payment.screenshot_url}" 
                             alt="Comprobante" 
                             class="screenshot-img"
                             onclick="viewScreenshot('${payment.screenshot_url}')">
                    </div>
                    
                    ${payment.notes ? `
                        <div class="payment-notes">
                            <div class="notes-label">Notas:</div>
                            <div class="notes-text">${payment.notes}</div>
                        </div>
                    ` : ''}
                    
                    <div class="payment-actions">
                        <button class="btn-approve" onclick="approvePayment('${payment.id}')">
                            <span class="action-icon">‚úÖ</span>
                            <span class="action-text">Aprobar</span>
                        </button>
                        <button class="btn-reject" onclick="rejectPayment('${payment.id}')">
                            <span class="action-icon">‚ùå</span>
                            <span class="action-text">Rechazar</span>
                        </button>
                    </div>
                `;
                
                container.appendChild(paymentElement);
            });
        }
        
        // Aprobar pago
        async function approvePayment(paymentId) {
            if (!confirm('¬øEst√°s seguro de aprobar este pago?')) return;
            
            try {
                const response = await fetch(`/api/payments/${paymentId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    alert('‚úÖ Pago aprobado exitosamente');
                    loadPayments();
                    loadStats();
                    loadVIPUsers();
                }
            } catch (error) {
                alert('‚ùå Error al aprobar el pago');
            }
        }
        
        // Rechazar pago
        async function rejectPayment(paymentId) {
            const reason = prompt('Motivo del rechazo:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/payments/${paymentId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                
                if (response.ok) {
                    alert('‚úÖ Pago rechazado');
                    loadPayments();
                }
            } catch (error) {
                alert('‚ùå Error al rechazar el pago');
            }
        }
        
        // Verificar captura de pantalla
        function viewScreenshot(url) {
            window.open(url, '_blank');
        }
        
        // Cargar estad√≠sticas
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('totalRevenue').textContent = `$${stats.total_revenue || 0}`;
                document.getElementById('totalUsers').textContent = stats.total_users || 0;
                document.getElementById('approvedToday').textContent = stats.approved_today || 0;
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }
        
        // Cargar usuarios VIP
        async function loadVIPUsers() {
            try {
                const response = await fetch('/api/vip-users');
                const users = await response.json();
                displayVIPUsers(users);
            } catch (error) {
                console.error('Error cargando usuarios VIP:', error);
            }
        }
        
        // Mostrar usuarios VIP
        function displayVIPUsers(users) {
            const container = document.getElementById('vipUsers');
            const countElement = document.getElementById('vipCount');
            
            countElement.textContent = users.length;
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üëë</div>
                        <div class="empty-text">No hay usuarios VIP a√∫n</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'vip-card';
                userElement.innerHTML = `
                    <div class="vip-header">
                        <div class="vip-badge">VIP</div>
                        <div class="vip-since">Desde: ${new Date(user.vip_since).toLocaleDateString()}</div>
                    </div>
                    
                    <div class="vip-body">
                        <div class="vip-user">
                            <div class="user-avatar">üë§</div>
                            <div class="user-details">
                                <div class="user-name">${user.first_name || ''}</div>
                                <div class="user-username">@${user.username || 'sin_usuario'}</div>
                                <div class="user-id">ID: ${user.telegram_id}</div>
                            </div>
                        </div>
                        
                        <div class="vip-plan">
                            <div class="plan-icon">üìã</div>
                            <div class="plan-details">
                                <div class="plan-name">${getPlanName(user.plan)}</div>
                                <div class="plan-price">$${user.plan_price} CUP</div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(userElement);
            });
        }
        
        // Refrescar datos
        function refreshData() {
            loadPayments();
            loadStats();
            loadVIPUsers();
        }
        
        // Volver atr√°s
        function goBack() {
            window.history.back();
        }
        
        // Helper: Obtener nombre del plan
        function getPlanName(planType) {
            const plans = {
                'basico': 'B√°sico (1 mes)',
                'premium': 'Premium (2 meses)',
                'vip': 'VIP (6 meses)'
            };
            return plans[planType] || planType;
        }
    </script>
</body>
</html>
